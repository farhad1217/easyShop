{% extends 'shop/base.html' %}
{% load shop_extras %}
{% block title %}‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü - EasyShop{% endblock %}
{% block content %}
<div class="container family-dashboard">
    <div class="family-header">
        <div class="account-info">
            <a href="{% url 'my_profile' %}" class="avatar avatar-link">
                {% if profile_avatar %}<img src="{{ profile_avatar.url }}" alt="">{% else %}üë§{% endif %}
            </a>
            <div>
                <span class="label">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</span>
                <a href="{% url 'my_profile' %}" class="username-link">{{ display_name }}</a>
            </div>
        </div>
        <div class="header-icons">
            <a href="{% url 'user_logout' %}" class="icon-btn logout-icon-btn" title="‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </a>
        </div>
    </div>

    {% if notice and notice.content %}
    <div class="notice-box card" style="margin-bottom: 20px; padding: 16px; background: #fef3c7; border-left: 4px solid var(--accent);">
        <strong>üìå ‡¶®‡ßã‡¶ü‡¶ø‡¶∏:</strong> {{ notice.content|linebreaksbr }}
    </div>
    {% endif %}

    <div class="market-list-section card">
        <h2 class="section-title">‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>
        <p class="section-subtitle">‡¶Ü‡¶ú ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßÄ ‡¶ï‡ßÄ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞?</p>
        <form method="post" action="{% url 'send_market_list' %}" class="list-form" id="bazarListForm">
            {% csrf_token %}
            {% if form.non_field_errors %}<div style="color: #dc2626; font-size: 0.9rem; margin-bottom: 12px;">{{ form.non_field_errors.0 }}</div>{% endif %}
            <div class="input-wrapper">
                <textarea name="content" id="bazarListInput" rows="4" placeholder="‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡ßß. ‡¶Ü‡¶≤‡ßÅ ‡ß®. ‡¶™‡ßá‡¶Å‡¶Ø‡¶º‡¶æ‡¶ú)" style="width:100%;min-height:120px;padding:16px 48px 16px 16px;border:2px solid #e5e7eb;border-radius:12px;font-family:inherit;font-size:1rem;resize:vertical;">{{ form.content.value|default:"" }}</textarea>
                <span class="sparkle-icon">‚ú®</span>
                {% if form.content.errors %}<div style="color: #dc2626; font-size: 0.9rem; margin-top: 8px;">{{ form.content.errors.0 }}</div>{% endif %}
            </div>
            <button type="submit" class="btn-send">
                <span class="paper-plane">‚úàÔ∏è</span> ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®
            </button>
        </form>
    </div>

    <div class="history-folders history-folders-stacked">
        <div class="folder-row">
            <div class="folder-card delivered-folder collapsed">
                <h4 class="folder-title folder-title-click" data-folder="delivered" tabindex="0">Delivered <span class="folder-count">{{ delivered_lists|length }}</span> <span class="folder-chevron">‚ñº</span></h4>
                {% if delivered_lists %}
                <div class="folder-lists folder-lists-delivered folder-cards">
                    {% for list in delivered_lists %}
                    <div class="list-card list-card-delivered folder-list-card">
                        <div class="list-card-main">
                            <span class="list-icon">üìÑ</span>
                            <div class="list-info">
                                <span class="list-id">{{ list.list_id }}</span>
                                <span class="list-content-preview list-preview-click" data-list-id="{{ list.list_id }}" title="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®">{{ list.content|truncatechars:50|default:"-" }}</span>
                                <template class="list-full-content" data-list-id="{{ list.list_id }}">{{ list.content|numbered_list|linebreaksbr }}</template>
                                <span class="list-date"><span class="list-datetime">{% if list.delivered_at %}{{ list.delivered_at|date_card }}{% else %}{{ list.created_at|date_card }}{% endif %}</span></span>
                            </div>
                        </div>
                        {# Message icon hidden for delivered history #}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="folder-empty">‡¶è‡¶ñ‡¶®‡¶ì ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</p>
                {% endif %}
            </div>
            <div class="folder-card declined-folder collapsed">
            <h4 class="folder-title folder-title-click" data-folder="declined" tabindex="0">Cancelled <span class="folder-count">{{ declined_lists|length }}</span> <span class="folder-chevron">‚ñº</span></h4>
                {% if declined_lists %}
                <div class="folder-lists folder-lists-declined folder-cards">
                    {% for list in declined_lists %}
                    <div class="list-card list-card-declined folder-list-card">
                        <div class="list-card-main">
                            <span class="list-icon">üìÑ</span>
                            <div class="list-info">
                                <span class="list-id">{{ list.list_id }}</span>
                                <span class="list-content-preview list-preview-click" data-list-id="{{ list.list_id }}" title="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®">{{ list.content|truncatechars:50|default:"-" }}</span>
                                <template class="list-full-content" data-list-id="{{ list.list_id }}">{{ list.content|numbered_list|linebreaksbr }}</template>
                                <span class="list-date"><span class="list-datetime">{% if list.declined_at %}{{ list.declined_at|date_card }}{% else %}{{ list.created_at|date_card }}{% endif %}</span></span>
                            </div>
                        </div>
                        {# Message icon hidden for declined history #}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="folder-empty">‡¶è‡¶ñ‡¶®‡¶ì CANCELLED ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="list-history">
        <h3 class="history-title">‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</h3>
        {% if lists_with_status %}
        <div class="list-cards">
            {% for list, flow_status in lists_with_status %}
            <div class="list-card list-card-{{ list.status }}">
                <div class="list-card-main">
                    <span class="list-icon">üìÑ</span>
                    <div class="list-info">
                        <div class="list-id-row">
                            <span class="list-id">{{ list.list_id }}</span>
                            <span class="list-date"><span class="list-datetime">{{ list.created_at|date_card }}</span></span>
                        </div>
                        <span class="list-content-preview list-content-preview-2line list-preview-click" data-list-id="{{ list.list_id }}" title="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®">{{ list.content|first_three_preview|linebreaksbr }}</span>
                        <template class="list-full-content" data-list-id="{{ list.list_id }}">{{ list.content|numbered_list|linebreaksbr }}</template>
                        <div class="list-subtext">{% if flow_status %}{{ flow_status }}{% endif %}</div>
                        {% if list.status != 'approved' %}
                        <span class="status-badge status-{{ list.status }} status-one-line">{{ list.note|default:list.get_status_display }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="list-actions">
                    {# Edit/Delete ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ø‡¶ñ‡¶® list status pending/approved ‡¶è‡¶¨‡¶Ç flow status "Approved"/"Pending" ‚Äî "Preparing for delivery..." ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶®‡¶æ #}
                    {% if list.status == 'pending' or list.status == 'approved' %}
                        {% if not flow_status or flow_status == 'Approved' or flow_status == 'Pending' %}
                    <a href="{% url 'update_market_list' list.pk %}" class="action-btn edit-btn" title="‡¶Ü‡¶™‡¶°‡ßá‡¶ü">‚úèÔ∏è</a>
                    <a href="{% url 'delete_market_list' list.pk %}" class="action-btn delete-btn" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü" onclick="return confirm('‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?');">üóëÔ∏è</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-lists">‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡ßá ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡•§</p>
        {% endif %}
    </div>
</div>

<style>
.list-flow-status-badge {
    display: inline-block;
    margin-left: 8px;
    padding: 3px 10px;
    border-radius: 9999px;
    background: linear-gradient(135deg, rgba(37,99,235,0.25) 0%, rgba(59,130,246,0.2) 100%);
    border: 1px solid rgba(96,165,250,0.5);
    color: #2563eb;
    font-size: 0.75rem;
    font-weight: 600;
}
.list-subtext {
    font-size: 0.82rem;
    font-weight: 600;
    color: #2563eb;
    margin-top: 8px;
}
.list-subtext:not(:empty) {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 6px;
    background: rgba(37, 99, 235, 0.08);
    border-left: 3px solid #3b82f6;
}
</style>

<div id="listDetailModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ <span id="modalListId"></span></h3>
            <button type="button" class="modal-close" aria-label="‡¶¨‡¶®‡ßç‡¶ß">&times;</button>
        </div>
        <div class="modal-body" id="modalListContent"></div>
    </div>
</div>

<div id="toast" class="toast"></div>

<div id="userCommentModal" class="comment-modal-overlay">
    <div class="comment-modal-box">
        <div class="comment-modal-header">
            <h3>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</h3>
            <button type="button" class="comment-modal-close" aria-label="‡¶¨‡¶®‡ßç‡¶ß">&times;</button>
        </div>
        <iframe id="userCommentIframe" class="comment-modal-iframe" src="about:blank"></iframe>
    </div>
</div>

<style>
.comment-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
.comment-modal-overlay.active { display: flex; }
.comment-modal-box { background: white; border-radius: 16px; width: 100%; max-width: 560px; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.comment-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; }
.comment-modal-header h3 { margin: 0; font-size: 1.1rem; }
.comment-modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; line-height: 1; padding: 0 8px; }
.comment-modal-close:hover { color: #1f2937; }
.comment-modal-iframe { width: 100%; height: 60vh; min-height: 400px; border: none; display: block; }
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
.modal-overlay.active { display: flex; }
.modal-box { background: white; border-radius: 16px; max-width: 480px; width: 100%; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
.modal-box.modal-sm { max-width: 320px; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; }
.modal-header h3 { margin: 0; font-size: 1.1rem; }
.modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; line-height: 1; padding: 0 4px; }
.modal-close:hover { color: #1f2937; }
.modal-body { padding: 20px; overflow-y: auto; max-height: 60vh; white-space: pre-wrap; font-size: 0.95rem; }
.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: #1f2937; color: white; border-radius: 50px; font-size: 0.9rem; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1100; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
.toast.show { opacity: 1; visibility: visible; }
.toast.success { background: #059669; }
.toast.error { background: #dc2626; }
.family-dashboard { max-width: 560px; margin: 0 auto; }
.family-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
    padding: 12px 0;
}
.account-info { display: flex; align-items: center; gap: 12px; }
.avatar {
    width: 48px; height: 48px;
    border-radius: 50%;
    background: var(--primary);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}
.avatar-link { text-decoration: none; overflow: hidden; }
.avatar-link img { width: 100%; height: 100%; object-fit: cover; display: block; }
.account-info .label { display: block; font-size: 0.75rem; color: #6b7280; }
.account-info .username, .account-info .username-link { font-weight: 700; font-size: 1.1rem; }
.username-link { color: inherit; text-decoration: none; }
.username-link:hover { color: var(--primary); }
.header-icons { display: flex; gap: 12px; }
.msg-icon-wrap { position: relative; }
.msg-badge {
    position: absolute; top: -4px; right: -4px;
    background: #dc2626; color: white;
    font-size: 0.7rem; min-width: 18px; height: 18px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    padding: 0 4px;
}
.icon-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: #f3f4f6;
    display: flex; align-items: center; justify-content: center;
    text-decoration: none;
    color: var(--text);
}
.icon-btn:hover { background: #e5e7eb; }
.logout-icon-btn svg { display: block; }
.market-list-section { padding: 28px; margin-bottom: 28px; }
.section-title { font-size: 1.5rem; margin-bottom: 4px; }
.section-subtitle { color: #6b7280; margin-bottom: 20px; font-size: 1rem; }
.input-wrapper { position: relative; margin-bottom: 16px; }
.input-wrapper textarea {
    width: 100%;
    min-height: 120px;
    padding: 16px 48px 16px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-family: inherit;
    font-size: 1rem;
    resize: vertical;
}
.sparkle-icon {
    position: absolute;
    right: 16px;
    top: 16px;
    font-size: 1.2rem;
}
.btn-send {
    width: 100%;
    padding: 16px 24px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.btn-send:hover { background: var(--primary-dark); }
.list-history { margin-top: 28px; }
.history-title { margin-bottom: 20px; font-size: 1.25rem; font-weight: 800; color: #1e293b; letter-spacing: -0.02em; }
.list-cards { display: flex; flex-direction: column; gap: 14px; }
.list-card {
    background: white;
    border-radius: 14px;
    padding: 18px 20px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06), 0 0 1px rgba(0,0,0,0.04);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(0,0,0,0.04);
    transition: box-shadow 0.2s ease, transform 0.2s ease;
}
.list-card:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 0 1px rgba(0,0,0,0.06);
    transform: translateY(-1px);
}
.list-card-pending { border-left: 4px solid #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fff 22%); }
.list-card-approved { border-left: 4px solid #2563eb; background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 25%, #fff 40%); }
.list-card-delivered { border-left: 4px solid #059669; background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 20%, #fff 35%); }
.list-card-declined { border-left: 4px solid #dc2626; background: linear-gradient(135deg, #fef2f2 0%, #fef2f2 20%, #fff 35%); }
.list-card-main { display: flex; align-items: center; gap: 14px; flex: 1; }
.list-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.35rem;
    flex-shrink: 0;
    border: 1px solid rgba(148,163,184,0.3);
}
.list-card-approved .list-icon { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-color: rgba(96,165,250,0.4); }
.list-card-pending .list-icon { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: rgba(245,158,11,0.3); }
.list-card-delivered .list-icon { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-color: rgba(16,185,129,0.3); }
.list-card-declined .list-icon { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-color: rgba(220,38,38,0.25); }
.list-info { display: flex; flex-direction: column; gap: 4px; }
.list-id-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.list-id-row .list-datetime { background: none; border: none; box-shadow: none; padding: 0; color: #64748b; font-weight: 500; font-size: 0.82rem; }
.list-id { font-weight: 800; font-size: 1rem; color: #1e293b; letter-spacing: 0.01em; }
.list-content-preview { color: #475569; font-size: 0.92rem; cursor: pointer; line-height: 1.45; }
.list-content-preview-2line {
    display: block;
    overflow: hidden;
    max-height: 2.9em;
    line-height: 1.45;
}
.list-content-preview:hover { color: var(--primary); text-decoration: underline; }
.list-date { font-size: 0.8rem; }
.list-datetime {
    display: inline-block;
    padding: 4px 10px;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    font-weight: 700;
    font-size: 0.85rem;
    border-radius: 8px;
    border: 1px solid #93c5fd;
    box-shadow: 0 1px 3px rgba(59, 130, 246, 0.2);
}
.folder-meta .list-datetime { font-size: 0.75rem; padding: 3px 8px; }
.status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    line-height: 1.2;
}
.status-pending { background: #f3f4f6; color: #4b5563; }
.status-approved { background: #dbeafe; color: #1e40af; }
.status-delivered { background: #d1fae5; color: #065f46; }
.status-declined { background: #fee2e2; color: #991b1b; }
.list-actions { display: flex; gap: 8px; }
.action-btn {
    padding: 8px 12px;
    border-radius: 10px;
    text-decoration: none;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}
.action-btn:hover { transform: scale(1.05); }
.edit-btn { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; border: 1px solid rgba(59,130,246,0.3); }
.edit-btn:hover { box-shadow: 0 2px 8px rgba(59,130,246,0.25); }
.delete-btn { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; border: 1px solid rgba(220,38,38,0.2); }
.delete-btn:hover { box-shadow: 0 2px 8px rgba(220,38,38,0.2); }
.comment-btn { background: #d1fae5; color: #065f46; }
.no-lists {
    color: #64748b;
    text-align: center;
    padding: 32px 24px;
    background: #f8fafc;
    border-radius: 14px;
    border: 2px dashed #e2e8f0;
    font-size: 0.95rem;
}
.history-folders { margin-top: 24px; margin-bottom: 28px; }
.history-folders-stacked .folder-row { display: flex; flex-direction: column; gap: 14px; }
.folder-cards { display: flex; flex-direction: column; gap: 12px; max-height: 220px; overflow-y: auto; }
.folder-list-card {
    margin: 0;
    padding: 16px 18px;
    border-radius: 14px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06), 0 0 1px rgba(0,0,0,0.04);
    border: 1px solid rgba(0,0,0,0.04);
    transition: box-shadow 0.2s ease, transform 0.2s ease;
}
.folder-list-card:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 0 1px rgba(0,0,0,0.06);
    transform: translateY(-1px);
}
.folder-list-card .list-icon { width: 40px; height: 40px; font-size: 1.25rem; }
.folder-card {
    background: white;
    border-radius: 14px;
    padding: 16px 18px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06), 0 0 1px rgba(0,0,0,0.04);
    border: 1px solid rgba(0,0,0,0.04);
}
.delivered-folder { border-top: 4px solid #059669; }
.declined-folder { border-top: 4px solid #dc2626; }
.folder-title { font-size: 1rem; font-weight: 700; margin: 0 0 12px 0; color: #1e293b; display: flex; align-items: center; gap: 8px; }
.folder-title-click { cursor: pointer; user-select: none; padding: 6px 0; transition: opacity 0.2s ease; }
.folder-title-click:hover { opacity: 0.85; }
.folder-chevron { font-size: 0.7rem; margin-left: 4px; transition: transform 0.25s ease; }
.folder-card.collapsed .folder-chevron { transform: rotate(-90deg); }
.folder-card.collapsed .folder-lists { display: none !important; }
.folder-count {
    font-size: 0.8rem;
    font-weight: 700;
    min-width: 24px;
    height: 24px;
    border-radius: 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 8px;
}
.delivered-folder .folder-count { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; }
.declined-folder .folder-count { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; }
.folder-lists { display: flex; flex-direction: column; gap: 6px; max-height: 120px; overflow-y: auto; }
.folder-list-item { padding: 8px 10px; background: #f9fafb; border-radius: 6px; font-size: 0.85rem; display: flex; flex-wrap: wrap; align-items: baseline; gap: 4px; }
.folder-serial { font-weight: 700; color: #6b7280; flex-shrink: 0; }
.folder-list-item .list-content-preview { flex: 1; min-width: 0; }
.folder-meta { font-size: 0.75rem; color: #9ca3af; }
.folder-comment-btn { font-size: 0.9rem; padding: 2px 6px; margin-left: auto; }
.folder-empty {
    color: #64748b;
    font-size: 0.9rem;
    padding: 20px 16px;
    margin: 0;
    background: #f8fafc;
    border-radius: 10px;
    border: 2px dashed #e2e8f0;
}
.status-one-line { white-space: nowrap; display: inline-block; margin-top: 4px; }
@media (max-width: 768px) {
    .family-dashboard { max-width: 100%; padding: 0; }
    .market-list-section { padding: 20px; }
    .modal-box { margin: 12px; max-height: 85vh; }
    .modal-overlay { padding: 12px; }
}
@media (max-width: 600px) {
    .family-header { flex-direction: column; align-items: flex-start; gap: 12px; }
    .list-card-main { flex-wrap: wrap; }
    .list-card { flex-direction: column; align-items: flex-start; gap: 10px; }
    .list-actions { width: 100%; justify-content: flex-end; }
    .section-title { font-size: 1.3rem; }
    .input-wrapper textarea { padding: 14px; font-size: 0.95rem; }
    .comment-modal-iframe { min-height: 50vh; }
}
@media (max-width: 400px) {
    .market-list-section { padding: 16px; }
    .btn-send { padding: 14px 20px; font-size: 1rem; }
    .list-id { font-size: 0.85rem; }
    .avatar { width: 40px; height: 40px; font-size: 1.2rem; }
}
</style>
{% endblock %}
{% block extra_js %}
<script>
(function() {
    var toast = document.getElementById('toast');
    var params = new URLSearchParams(window.location.search);
    var t = params.get('toast');
    if (t === 'sent') {
        toast.textContent = '‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!';
        toast.className = 'toast show success';
        setTimeout(function(){ toast.classList.remove('show'); history.replaceState({}, '', window.location.pathname); }, 2500);
    }

    var detailModal = document.getElementById('listDetailModal');
    document.querySelectorAll('.list-preview-click').forEach(function(el) {
        el.addEventListener('click', function() {
            var id = this.getAttribute('data-list-id');
            var tpl = document.querySelector('template.list-full-content[data-list-id="' + id + '"]');
            document.getElementById('modalListId').textContent = '#' + id;
            document.getElementById('modalListContent').innerHTML = tpl ? tpl.innerHTML : '-';
            detailModal.classList.add('active');
        });
    });
    document.querySelector('#listDetailModal .modal-close').addEventListener('click', function() {
        detailModal.classList.remove('active');
    });
    detailModal.addEventListener('click', function(e) {
        if (e.target === detailModal) detailModal.classList.remove('active');
    });
    document.querySelectorAll('.folder-title-click').forEach(function(title) {
        title.addEventListener('click', function() {
            var card = title.closest('.folder-card');
            if (card) card.classList.toggle('collapsed');
        });
    });
    var commentModal = document.getElementById('userCommentModal');
    var commentIframe = document.getElementById('userCommentIframe');
    document.querySelectorAll('.open-comment-modal').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            commentIframe.src = this.getAttribute('data-comment-url');
            commentModal.classList.add('active');
        });
    });
    commentModal.querySelector('.comment-modal-close').addEventListener('click', function() {
        commentIframe.src = 'about:blank';
        commentModal.classList.remove('active');
    });
    commentModal.addEventListener('click', function(e) {
        if (e.target === commentModal) {
            commentIframe.src = 'about:blank';
            commentModal.classList.remove('active');
        }
    });
})();    (function(){
        var textarea = document.getElementById('bazarListInput');
        var form = document.getElementById('bazarListForm');
        var btnSend = form && form.querySelector('.btn-send');
        if (!textarea || !form || !btnSend) return;
        function cleanContent() {
            var v = textarea.value;
            var lines = v.split('\n').map(function(s){ return s.trim(); }).filter(Boolean);
            textarea.value = lines.join('\n');
        }
        textarea.addEventListener('blur', cleanContent);
        form.addEventListener('submit', function(e) {
            cleanContent();
            if (!textarea.value.trim()) {
                e.preventDefault();
                alert('‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§');
                textarea.focus();
                return;
            }
        });
    })();
</script>
{% endblock %}