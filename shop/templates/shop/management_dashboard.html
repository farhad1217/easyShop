{% extends 'shop/base.html' %}
{% load shop_extras %}
{% block title %}‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° - EasyShop{% endblock %}
{% block extra_css %}
/* ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßã‡¶°‡ßá ‡¶¨‡¶°‡¶ø‡¶∞ ‡¶≤‡¶æ‡¶á‡¶ü ‡¶ü‡¶ø‡¶≤/‡¶∏‡¶æ‡¶Ø‡¶º‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶™ ‡¶∏‡¶∞‡¶æ‡¶® ‚Äì ‡¶™‡ßÅ‡¶∞‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶°‡¶æ‡¶∞‡ßç‡¶ï */
body { background: #020617 !important; }
.admin-theme {
    background: #020617;
    min-height: 100vh;
}
.admin-theme .container {
    max-width: 960px;
    padding-bottom: 40px;
}
.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 22px 18px;
    margin-bottom: 10px;
    color: white;
    border-radius: 18px;
    background: radial-gradient(circle at top left, rgba(56,189,248,0.25), transparent 55%),
                radial-gradient(circle at bottom right, rgba(244,114,182,0.28), transparent 55%),
                rgba(15,23,42,0.92);
    box-shadow: 0 22px 60px rgba(15,23,42,0.9);
    border: 1px solid rgba(148,163,184,0.5);
    backdrop-filter: blur(16px);
}
.admin-brand {
    display: flex;
    align-items: center;
    gap: 14px;
}
.admin-brand .icon {
    font-size: 2rem;
    filter: drop-shadow(0 0 10px rgba(251,191,36,0.5));
}
.admin-brand h1 {
    font-size: 1.35rem;
    margin: 0;
    letter-spacing: 0.04em;
    text-transform: uppercase;
}
.admin-brand .sub {
    font-size: 0.8rem;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.12em;
}
.admin-header-icons a {
    color: white;
    margin-left: 16px;
    text-decoration: none;
    font-size: 1.1rem;
    display: inline-flex;
    align-items: center;
    padding: 9px 12px;
    border-radius: 9999px;
    border: 1px solid rgba(148,163,184,0.6);
    background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
    box-shadow: 0 10px 30px rgba(15,23,42,0.8);
    transition: background 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
}
.admin-header-icons a:hover {
    background: radial-gradient(circle at top, rgba(30,64,175,0.95), rgba(15,23,42,0.9));
    border-color: rgba(191,219,254,0.9);
    transform: translateY(-1px);
    box-shadow: 0 16px 40px rgba(30,64,175,0.75);
}
.logout-btn svg { display: block; }
.filter-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}
.filter-card {
    position: relative;
    background: radial-gradient(circle at top left, rgba(55,65,81,0.9), rgba(17,24,39,0.98));
    color: white;
    padding: 16px 18px;
    border-radius: 14px;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    border: 1px solid rgba(75,85,99,0.9);
    box-shadow: 0 14px 40px rgba(15,23,42,0.9);
    transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
}
.filter-card::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 1px solid transparent;
    pointer-events: none;
}
.filter-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 18px 50px rgba(15,23,42,1);
    border-color: rgba(209,213,219,0.6);
}
.filter-card.active {
    background: radial-gradient(circle at top, rgba(37,99,235,1), rgba(30,64,175,1));
    border-color: rgba(191,219,254,0.9);
    box-shadow: 0 20px 60px rgba(30,64,175,0.95);
}
.filter-card .count {
    font-size: 1.1rem;
    font-weight: 800;
}
.filter-card .label {
    font-size: 0.8rem;
    opacity: 0.95;
    letter-spacing: 0.04em;
    text-transform: uppercase;
}
.total-order-lists-section {
    padding: 14px 16px;
    margin-top: 20px;
    border-radius: 12px;
    border: 2px solid #0ea5e9;
    background: #164e63;
    margin-bottom: 20px;
}
.total-order-lists-section .total-order-lists-header { color: #a5f3fc; margin-bottom: 12px; }
.total-order-lists-badge {
    display: inline-flex; align-items: center; justify-content: center;
    min-width: 24px; height: 24px; padding: 0 8px; margin-left: 10px;
    border-radius: 9999px; background: #0ea5e9; border: 1px solid #38bdf8;
    color: #fff; font-size: 0.85rem; font-weight: 700; vertical-align: middle;
}
.total-order-lists-section .delivery-flow-section-toggle { margin-left: auto; background: rgba(6,182,212,0.3); border-color: #06b6d4; color: #e0f2fe; }
.total-order-lists-section .delivery-flow-section-toggle:hover { background: rgba(6,182,212,0.5); }
.total-order-lists-section.collapsed .total-order-lists-body { display: none !important; }
#totalOrderListsSection {
    border-color: #ca8a04;
    background: linear-gradient(135deg, #422006 0%, #713f12 100%);
}
#totalOrderListsSection .total-order-lists-header { color: #fde047; }
#totalOrderListsSection .total-order-lists-badge { background: #ca8a04; border-color: #eab308; }
#totalOrderListsSection .delivery-flow-section-toggle { background: rgba(202,138,4,0.3); border-color: #ca8a04; color: #fef08a; }
#totalOrderListsSection .delivery-flow-section-toggle:hover { background: rgba(202,138,4,0.5); }
#declinedOrderListsSection {
    border-color: #dc2626;
    background: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
}
#declinedOrderListsSection .total-order-lists-header { color: #fca5a5; }
#declinedOrderListsSection .total-order-lists-badge { background: #dc2626; border-color: #f87171; }
#declinedOrderListsSection .delivery-flow-section-toggle { background: rgba(220,38,38,0.3); border-color: #dc2626; color: #fecaca; }
#declinedOrderListsSection .delivery-flow-section-toggle:hover { background: rgba(220,38,38,0.5); }
#deliveredOrderListsSection {
    border-color: #059669;
    background: linear-gradient(135deg, #052e16 0%, #14532d 100%);
}
#deliveredOrderListsSection .total-order-lists-header { color: #86efac; }
#deliveredOrderListsSection .total-order-lists-badge { background: #059669; border-color: #34d399; }
#deliveredOrderListsSection .delivery-flow-section-toggle { background: rgba(5,150,105,0.3); border-color: #059669; color: #d1fae5; }
#deliveredOrderListsSection .delivery-flow-section-toggle:hover { background: rgba(5,150,105,0.5); }
.total-actions-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}
.total-action-btn {
    padding: 12px 16px;
    color: white;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: opacity 0.2s, transform 0.2s;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    display: inline-flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}
.total-action-btn:hover { opacity: 0.92; transform: translateY(-1px); }
.total-action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.total-action-btn.active { box-shadow: 0 0 0 2px rgba(255,255,255,0.4); }
.total-action-btn.total-active { box-shadow: 0 0 0 2px rgba(255,255,255,0.45); }
.flow-status-pill {
    transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
}
.flow-status-pill.pulse {
    transform: translateY(-1px) scale(1.03);
    box-shadow: 0 0 0 2px rgba(96,165,250,0.8);
    background-color: #1d4ed8 !important;
    color: #f9fafb !important;
}

#deliveryFlowToggleBtn,
#consolidatedToggleBtn,
#userViewToggleBtn {
    background: linear-gradient(135deg, #eab308 0%, #ca8a04 50%, #a16207 100%);
    color: #ffffff;
    box-shadow: 0 4px 14px rgba(234,179,8,0.4);
}
#deliveryFlowToggleBtn:hover,
#consolidatedToggleBtn:hover,
#userViewToggleBtn:hover {
    opacity: 0.96;
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(234,179,8,0.5);
}
.list-status-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 12px;
    border-radius: 9999px;
    margin-left: 10px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    background: rgba(255,255,255,0.1);
    color: #e5e7eb;
    line-height: 1.2;
    min-height: 28px;
    box-sizing: border-box;
}
.list-status-chip.has-custom {
    background: #facc15;
    color: #1f2937;
}
.inline-status-text {
    margin-top: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    color: #9ca3af;
}
.inline-status-text.has-custom { color: #facc15; }
.nav-cards { display: flex; flex-direction: row; flex-wrap: wrap; gap: 14px; margin: 22px 0 28px; }
.nav-card { flex: 1; min-width: 240px; }
.nav-card {
    background: radial-gradient(circle at top left, rgba(55,65,81,0.95), rgba(17,24,39,0.98));
    color: white;
    padding: 18px 20px;
    border-radius: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-decoration: none;
    border: 1px solid rgba(75,85,99,0.8);
    box-shadow: 0 16px 45px rgba(15,23,42,0.95);
    transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
}
.nav-card:hover {
    background: radial-gradient(circle at top left, rgba(59,130,246,0.18), rgba(17,24,39,0.98));
    border-color: rgba(191,219,254,0.9);
    transform: translateY(-2px);
    box-shadow: 0 22px 60px rgba(30,64,175,0.9);
}
.nav-card .nav-icon { font-size: 1.5rem; display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 10px; flex-shrink: 0; }
.nav-card .nav-icon.nav-icon-delivery { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px; box-sizing: border-box; }
.nav-card .nav-icon.nav-icon-user { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 8px; box-sizing: border-box; }
.nav-card .nav-icon svg { width: 24px; height: 24px; }
.nav-card .nav-text h3 { margin: 0 0 4px 0; font-size: 1rem; }
.nav-card .nav-text p { margin: 0; font-size: 0.8rem; opacity: 0.8; }
.delivery-path-pending-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
    padding: 0 8px;
    background: #dc2626;
    color: white;
    font-size: 0.85rem;
    font-weight: 800;
    border-radius: 9999px;
}
.list-entry {
    background: radial-gradient(circle at top left, rgba(55,65,81,0.95), rgba(15,23,42,0.98));
    color: white;
    padding: 20px 20px 18px;
    border-radius: 16px;
    margin-bottom: 18px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    border: 1px solid rgba(75,85,99,0.9);
    box-shadow: 0 18px 55px rgba(15,23,42,1);
}
.list-entry-delivered {
    border-left: 4px solid #059669;
    background: linear-gradient(135deg, rgba(5,150,105,0.25) 0%, rgba(55,65,81,0.95) 15%, rgba(15,23,42,0.98) 100%);
    border-color: rgba(16,185,129,0.5);
    box-shadow: 0 18px 55px rgba(15,23,42,1), 0 0 0 1px rgba(16,185,129,0.2);
}
.list-entry-top-row {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
}
.list-entry-pack-number {
    font-size: 0.95rem;
    font-weight: 700;
    color: #93c5fd;
    letter-spacing: 0.02em;
}
.list-entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
}
.list-entry .user-date { display: flex; align-items: center; gap: 10px; }
.list-datetime-admin {
    display: inline-flex;
    align-items: center;
    padding: 0 12px;
    height: 24px;
    box-sizing: border-box;
    background: rgba(20,184,166,0.2);
    border: 1px solid rgba(94,234,212,0.5);
    color: #5eead4;
    font-weight: 600;
    font-size: 0.7rem;
    border-radius: 4px;
}
.list-entry .content { color: #d1d5db; margin: 8px 0; }
.list-entry .actions { display: flex; gap: 8px; flex-shrink: 0; }
.list-entry-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
.list-section {
    background: #1f2937;
    border-radius: 10px;
    padding: 16px;
    border: 1px solid #4b5563;
}
.list-section h4 { margin: 0 0 10px 0; font-size: 0.95rem; color: #9ca3af; }
.list-section-content { color: #d1d5db; white-space: pre-wrap; font-size: 0.9rem; min-height: 60px; }
.list-section-content.ai-loading { color: #9ca3af; font-style: italic; }
.ai-generate-btn {
    margin-top: 8px;
    padding: 8px 14px;
    background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: opacity 0.2s;
}
.ai-generate-btn:hover { opacity: 0.9; }
.ai-generate-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.list-entry .action-icon {
    width: 36px; height: 36px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    text-decoration: none;
    font-size: 1.1rem;
}
.action-delete { background: #dc2626; color: white; }
.action-approve { background: #2563eb; color: white; }
.action-edit { background: #059669; color: white; }
.action-revert { background: #f59e0b; color: white; }
.action-comment { background: #059669; color: white; }
.action-restore { background: #4ade80; color: #064e3b; }
.no-lists { color: #9ca3af; text-align: center; padding: 40px; }
.list-entry-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
.ai-generate-all-btn { padding: 10px 18px; background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: opacity 0.2s; }
.ai-generate-all-btn:hover { opacity: 0.9; }
.ai-generate-all-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.list-entry-actions { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.inline-panel { display: none; margin-bottom: 20px; }
.inline-panel.show { display: block; }
.inline-merged-list { background: #374151; padding: 20px; border-radius: 12px; border: 1px solid #4b5563; cursor: pointer; user-select: none; }
.inline-merged-list:hover { border-color: #6b7280; }
.inline-merged-list .copy-hint { font-size: 0.8rem; color: #9ca3af; margin-top: 10px; }
.inline-merged-list .list-section-content { margin: 0; }
.inline-merged-list ul { list-style: none; padding: 0; margin: 0; }
.inline-merged-list li { padding: 8px 0; border-bottom: 1px solid #4b5563; color: #d1d5db; font-size: 0.95rem; }
.inline-merged-list li:last-child { border-bottom: none; }
.consolidated-copy-toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #059669; color: white; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; z-index: 9999; animation: fadeOut 2s ease 1s forwards; }
@keyframes fadeOut { to { opacity: 0; } }
.inline-panel .pdf-btn { display: inline-block; margin-bottom: 12px; padding: 8px 14px; background: #059669; color: white; border-radius: 8px; text-decoration: none; font-size: 0.9rem; }
.inline-panel .pdf-btn:hover { background: #047857; color: white; }
.inline-user-list { list-style: none; padding: 0; margin: 0; }
.inline-user-item { margin-bottom: 10px; }
.inline-user-click { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #374151; border-radius: 10px; transition: background 0.2s; }
.inline-user-click .name { flex: 1; font-weight: 600; font-size: 0.95rem; color: #34d399; cursor: pointer; }
.inline-user-click .name:hover { text-decoration: underline; }
.inline-user-badge { min-width: 24px; height: 24px; padding: 0 8px; background: #8b5cf6; color: white; font-size: 0.85rem; font-weight: 700; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; }
.inline-user-chevron { font-size: 0.7rem; transition: transform 0.25s; }
.inline-user-item.open .inline-user-chevron { transform: rotate(180deg); }
.inline-lists-dropdown { display: none; margin-top: 8px; padding: 14px 18px; background: #1f2937; border-radius: 10px; border: 1px solid #4b5563; }
.inline-lists-dropdown.show { display: block; }
.inline-list-item { background: #374151; padding: 14px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #4b5563; }
.inline-list-item:last-child { margin-bottom: 0; }
.inline-list-item .meta { font-size: 0.85rem; color: #9ca3af; margin-bottom: 6px; }
.inline-list-item .meta a { color: #60a5fa; text-decoration: none; }
.inline-list-item .meta a:hover { text-decoration: underline; }
.inline-list-item .content { color: #d1d5db; white-space: pre-wrap; font-size: 0.85rem; }
.inline-datetime { display: inline-block; padding: 2px 6px; background: #2563eb; color: white; font-size: 0.75rem; font-weight: 700; border-radius: 6px; }
.inline-panel-empty { color: #9ca3af; padding: 16px; }
.inline-panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.inline-panel-title { font-size: 0.95rem; font-weight: 600; color: #e5e7eb; display: inline-flex; align-items: center; gap: 6px; }
.inline-panel-back { border-radius: 9999px; border: 1px solid #4b5563; background: #111827; color: #e5e7eb; font-size: 0.78rem; padding: 4px 10px; cursor: pointer; }
.inline-panel-back:hover { background: #1f2937; }
/* ========== Delivery Flow Set ‚Äì ‡¶∞‡¶ô ‡¶ì ‡¶π‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶æ‡¶∞‡ßç‡¶ï‡¶ø (‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶∏‡¶π‡¶ú) ========== */
.delivery-flow-panel {
    display: none;
    margin-top: 12px;
    margin-bottom: 24px;
    padding: 24px 22px 22px;
    border-radius: 18px;
    background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    border: 2px solid #334155;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.03);
}
.delivery-flow-panel.show { display: block; }
/* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‚Äì ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶∂‡ßÄ‡¶∞‡ßç‡¶∑, ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ */
.delivery-flow-header {
    display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;
    margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid #475569;
}
.delivery-flow-header-title {
    margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 800; letter-spacing: 0.04em;
    color: #e2e8f0; display: inline-flex; align-items: center; gap: 8px;
}
.delivery-flow-header-title::before { content: '‚è±'; font-size: 1.15rem; color: #a78bfa; }
.delivery-flow-header-desc {
    margin: 0; font-size: 0.88rem; color: #94a3b8; line-height: 1.5; max-width: 420px;
}
/* ‡¶∏‡ßç‡¶ü‡ßá‡¶™ ‡¶¨‡ßç‡¶≤‡¶ï ‡ßß ‚Äì ‡¶´‡ßç‡¶≤‡ßã ‡¶∏‡ßá‡¶ü (‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶è‡¶ï‡¶∏‡ßá‡¶®‡ßç‡¶ü, ‚Äú‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‚Äù) */
.delivery-flow-step-block {
    margin-bottom: 28px; padding: 20px 18px; border-radius: 14px;
    background: rgba(30, 41, 59, 0.7); border: 1px solid #334155;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
}
.delivery-flow-step-block:last-of-type { margin-bottom: 0; }
.delivery-flow-step-flows {
    border-left: 4px solid #f59e0b;
}
.delivery-flow-step-orders {
    border-left: 4px solid #06b6d4;
}
.delivery-flow-step-title {
    margin: 0 0 6px 0; font-size: 1rem; font-weight: 800; color: #f1f5f9;
    display: flex; align-items: center; gap: 10px;
}
.delivery-flow-step-flows .delivery-flow-step-num {
    background: #f59e0b; color: #422006; border: 2px solid #fbbf24;
}
.delivery-flow-step-orders .delivery-flow-step-num {
    background: #06b6d4; color: #083344; border: 2px solid #22d3ee;
}
.delivery-flow-step-title .delivery-flow-step-num + .delivery-flow-step-toggle { margin-left: 0.5em; }
.delivery-flow-step-toggle {
    display: inline-flex; align-items: center; justify-content: center;
    width: 36px; height: 36px; min-width: 36px; border-radius: 8px;
    border: 2px solid rgba(245,158,11,0.7); background: rgba(245,158,11,0.25);
    color: #fef3c7; font-size: 1rem; cursor: pointer; flex-shrink: 0;
    transition: background 0.2s ease, border-color 0.2s ease;
}
.delivery-flow-step-toggle:hover { background: rgba(245,158,11,0.4); border-color: #f59e0b; }
.delivery-flow-step-flows.collapsed .delivery-flow-step-body { display: none !important; }
.delivery-flow-step-num {
    display: inline-flex; align-items: center; justify-content: center;
    width: 28px; height: 28px; border-radius: 50%;
    font-size: 0.9rem; font-weight: 800; flex-shrink: 0;
}
.delivery-flow-step-desc {
    margin: 0 0 16px 0; font-size: 0.82rem; color: #94a3b8; line-height: 1.5;
    padding-left: 38px;
}
.delivery-flow-step-orders .delivery-flow-step-desc { margin-bottom: 14px; }
.delivery-flow-step-flows .time-flow-list { margin-top: 4px; }
.delivery-flow-step-flows .delivery-flow-actions { margin-top: 16px; padding-top: 14px; border-top-color: #475569; }
/* ‡¶¨‡¶æ‡¶ü‡¶® ‚Äì ‡¶è‡¶ï‡¶∂‡¶® ‡¶∞‡¶ô‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ */
.delivery-flow-btn {
    padding: 10px 20px; border-radius: 12px; border: none; cursor: pointer;
    font-size: 0.9rem; font-weight: 700; letter-spacing: 0.02em;
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    color: #fff; display: inline-flex; align-items: center; gap: 8px;
    box-shadow: 0 2px 10px rgba(99,102,241,0.4);
    transition: transform 0.15s ease, box-shadow 0.2s ease;
}
.delivery-flow-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(99,102,241,0.5); }
.delivery-flow-actions .delivery-flow-btn {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    box-shadow: 0 2px 10px rgba(16,185,129,0.4);
}
.delivery-flow-actions .delivery-flow-btn:hover { box-shadow: 0 4px 16px rgba(16,185,129,0.5); }
/* ‡¶´‡ßç‡¶≤‡ßã ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ì ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡ßç‡¶ü‡ßá‡¶ü */
.time-flow-list { display: flex; flex-direction: column; gap: 14px; min-height: 20px; }
.time-flow-list-empty {
    padding: 24px 20px; text-align: center; border-radius: 12px;
    background: rgba(51, 65, 85, 0.4); border: 2px dashed #475569;
    color: #94a3b8; font-size: 0.9rem; line-height: 1.5;
}
.time-flow-list-empty strong { display: block; margin-bottom: 6px; color: #a78bfa; }
/* ‡¶´‡ßç‡¶≤‡ßã ‡¶∞‡ßã ‚Äì ‡¶è‡¶ï ‡¶è‡¶ï‡¶ü‡¶æ ‡¶´‡ßç‡¶≤‡ßã, ‡¶á‡¶®‡ßç‡¶°‡¶ø‡¶ó‡ßã ‡¶¨‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ö‡ßá‡¶®‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º */
.time-flow-row {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    column-gap: 18px;
    row-gap: 12px;
    padding: 16px 18px;
    border-radius: 14px;
    background: rgba(30, 41, 59, 0.8);
    border: 1px solid #475569;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    position: relative;
    overflow: hidden;
}
.time-flow-row::before { content: ''; position: absolute; inset: 0; border-radius: inherit; border-left: 4px solid #6366f1; opacity: 1; pointer-events: none; }
.time-flow-row:hover { border-color: #64748b; transform: translateY(-1px); }
.time-flow-name {
    display: inline-flex; align-items: center; gap: 8px; font-weight: 800; font-size: 0.95rem; color: #c7d2fe;
    min-width: 88px; z-index: 1; white-space: nowrap;
}
.time-flow-count {
    min-width: 24px; height: 24px; padding: 0 7px; border-radius: 9999px;
    background: #4f46e5; border: 1px solid #6366f1; color: #e0e7ff;
    font-size: 0.78rem; font-weight: 700; display: inline-flex; align-items: center; justify-content: center;
}
.time-flow-fields { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; justify-content: flex-start; z-index: 1; }
.time-flow-field { display: flex; flex-direction: column; gap: 5px; min-width: 140px; }
.time-flow-field label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.07em; color: #94a3b8; font-weight: 600; }
.time-flow-field input {
    padding: 9px 11px; border-radius: 10px; border: 1px solid #475569; background: #0f172a;
    color: #e2e8f0; font-size: 0.86rem;
}
.time-flow-field input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.3); }
.time-flow-separator { font-size: 0.85rem; font-weight: 600; color: #64748b; margin: 4px 2px 0; align-self: flex-end; }
.time-flow-icon-btn {
    border-radius: 10px; border: 1px solid rgba(239,68,68,0.6);
    background: rgba(239,68,68,0.12); color: #fecaca;
    cursor: pointer; padding: 6px 12px; font-size: 0.85rem;
    display: inline-flex; align-items: center; justify-content: center; gap: 4px;
    transition: background 0.2s ease, border-color 0.2s ease, transform 0.12s ease, box-shadow 0.2s ease;
}
.time-flow-icon-btn:hover { background: rgba(239,68,68,0.25); border-color: #f87171; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(239,68,68,0.25); }
/* Send Order Status ‚Äì ‡¶≠‡¶æ‡¶Ø‡¶º‡ßã‡¶≤‡ßá‡¶ü ‡¶ü‡¶ø‡¶®‡ßç‡¶ü, ‚Äú‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ú‡ßã‡¶®‚Äù ‡¶¨‡ßã‡¶ù‡¶æ‡¶§‡ßá */
.time-flow-status-block { min-width: 0; flex: 1 1 360px; max-width: 520px; margin-left: 4px; }
.time-flow-status-block > label {
    display: block; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em;
    color: #a78bfa; font-weight: 700; margin-bottom: 6px;
}
.time-flow-status-row {
    display: flex; flex-wrap: wrap; align-items: center; gap: 8px;
    padding: 10px 14px; border-radius: 12px;
    background: rgba(99, 102, 241, 0.12); border: 1px solid rgba(129, 140, 248, 0.4);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
}
.time-flow-status-select {
    flex: 1 1 140px; min-width: 120px; min-height: 36px;
    padding: 6px 12px 6px 10px; border-radius: 10px;
    border: 1px solid #475569; background: rgba(15, 23, 42, 0.8);
    color: #e0e7ff; font-size: 0.85rem; font-weight: 600;
    cursor: pointer; transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
.time-flow-status-select:hover { border-color: #6366f1; }
.time-flow-status-select:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.3); }
.time-flow-status-select option { background: #1e293b; color: #e2e8f0; }
.flow-status-pill {
    display: inline-flex; align-items: center; justify-content: center; gap: 4px;
    padding: 6px 12px; min-height: 36px; border-radius: 10px;
    font-size: 0.8rem; font-weight: 600; cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}
.flow-status-pill:hover { transform: translateY(-1px); }
.time-flow-status-create-btn {
    border: 1px solid rgba(129, 140, 248, 0.6); background: rgba(99, 102, 241, 0.2);
    color: #c7d2fe;
}
.time-flow-status-create-btn:hover { border-color: #818cf8; box-shadow: 0 2px 8px rgba(99,102,241,0.3); }
.time-flow-status-save-btn {
    border: 1px solid rgba(52, 211, 153, 0.5); background: rgba(16, 185, 129, 0.15);
    color: #6ee7b7;
}
.time-flow-status-save-btn:hover { border-color: #34d399; box-shadow: 0 2px 8px rgba(16,185,129,0.25); }
.time-flow-status-delete-btn {
    border: 1px solid rgba(248, 113, 113, 0.5); background: rgba(239, 68, 68, 0.12);
    color: #fecaca;
}
.time-flow-status-delete-btn:hover { border-color: #f87171; box-shadow: 0 2px 8px rgba(239,68,68,0.25); }
.time-flow-status-input {
    flex: 1 1 140px; min-width: 100px; padding: 6px 12px !important; border-radius: 10px !important;
    border: 1px solid #475569 !important; background: rgba(15, 23, 42, 0.8) !important;
    color: #e0e7ff !important; font-size: 0.85rem !important;
}
.time-flow-status-input:focus { outline: none; border-color: #6366f1 !important; box-shadow: 0 0 0 2px rgba(99,102,241,0.3) !important; }
.delivery-flow-actions {
    margin-top: 20px; display: none; justify-content: flex-end; align-items: center;
    padding-top: 16px; border-top: 2px dashed #475569;
    gap: 12px;
}
.delivery-flow-total-badge {
    display: inline-flex; align-items: center; justify-content: center; min-width: 24px; height: 24px;
    padding: 0 6px; margin-left: 8px; border-radius: 9999px;
    background: #6366f1; border: 1px solid #818cf8; color: #fff; font-size: 0.8rem; font-weight: 700;
}
/* ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‚Äì ‡¶∏‡ßç‡¶ü‡ßá‡¶™ ‡ß® ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá, ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ */
.delivery-flow-sections {
    margin-top: 20px; padding-top: 16px; border-top: 2px dashed #475569;
    display: flex; flex-direction: column; gap: 16px;
}
.delivery-flow-section { padding: 14px 16px; border-radius: 12px; border: 2px solid; position: relative; overflow: hidden; }
.delivery-flow-section-title {
    display: flex; align-items: center; justify-content: space-between; gap: 12px;
    margin-bottom: 12px; font-size: 1rem; font-weight: 800;
    min-height: 48px; flex-wrap: wrap;
}
.delivery-flow-section-title .flow-num + .delivery-flow-section-status-select { margin-left: 0.5em; }
.delivery-flow-section-title .delivery-flow-section-status-select + .delivery-flow-section-toggle { margin-left: 0.5em; }
.delivery-flow-section-status-select {
    min-width: 100px; max-width: 160px; height: 36px;
    padding: 4px 10px; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.4); background: rgba(0,0,0,0.2);
    color: inherit; font-size: 0.85rem; font-weight: 600; cursor: pointer;
    flex-shrink: 0;
}
.delivery-flow-section-status-select:hover { border-color: rgba(255,255,255,0.6); }
.delivery-flow-section-status-select:focus { outline: none; border-color: rgba(255,255,255,0.8); box-shadow: 0 0 0 2px rgba(255,255,255,0.2); }
.delivery-flow-section-status-select option { background: #1e293b; color: #e2e8f0; }
.delivery-flow-section-title small { font-size: 0.8rem; font-weight: 600; }
.delivery-flow-section-toggle {
    display: inline-flex; align-items: center; justify-content: center;
    width: 38px; height: 38px; min-width: 38px; border-radius: 8px;
    border: 2px solid rgba(255,255,255,0.6); color: inherit; cursor: pointer;
    background: rgba(255,255,255,0.2); font-size: 1rem; margin-left: 0.5em;
    flex-shrink: 0; line-height: 1; transition: transform 0.2s ease, background 0.2s ease;
}
.delivery-flow-section-toggle:hover { background: rgba(255,255,255,0.35); }
.delivery-flow-section-body-cards { display: flex; flex-direction: column; gap: 10px; transition: opacity 0.2s ease; }
.delivery-flow-section.collapsed .delivery-flow-section-body-cards { display: none !important; }
.delivery-flow-cloned-card { margin: 0; }
/* ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤‡ßá ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶æ‡¶Æ */
.delivery-flow-section-title .flow-num {
    display: inline-flex; align-items: center; justify-content: center;
    width: 38px; height: 38px; min-width: 38px; border-radius: 50%;
    font-size: 1.35rem; font-weight: 800; line-height: 1;
    margin-left: 0; margin-right: 0.5em; flex-shrink: 0; /* ‡ß® ‡¶∏‡ßç‡¶™‡ßá‡¶∏ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨ ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶®‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá */
}
/* Flow 1 ‚Äì ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∞‡¶ô (‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá ‡¶∞‡¶ô ‡¶®‡ßá‡¶á) */
.delivery-flow-section:nth-child(1) { background: #14532d; border-color: #22c55e; }
.delivery-flow-section:nth-child(1) .delivery-flow-section-title { color: #bbf7d0; }
.delivery-flow-section:nth-child(1) .delivery-flow-section-title .flow-num { background: #22c55e; color: #052e16; }
.delivery-flow-section:nth-child(1) .delivery-flow-section-title small { color: #86efac; }
/* Flow 2 ‚Äì ‡¶ü‡¶ø‡¶≤ */
.delivery-flow-section:nth-child(2) { background: #0f4d47; border-color: #14b8a6; }
.delivery-flow-section:nth-child(2) .delivery-flow-section-title { color: #99f6e4; }
.delivery-flow-section:nth-child(2) .delivery-flow-section-title .flow-num { background: #14b8a6; color: #042f2e; }
.delivery-flow-section:nth-child(2) .delivery-flow-section-title small { color: #5eead4; }
/* Flow 3 ‚Äì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞/‡¶ï‡¶Æ‡¶≤‡¶æ */
.delivery-flow-section:nth-child(3) { background: #78350f; border-color: #f59e0b; }
.delivery-flow-section:nth-child(3) .delivery-flow-section-title { color: #fef3c7; }
.delivery-flow-section:nth-child(3) .delivery-flow-section-title .flow-num { background: #f59e0b; color: #451a03; }
.delivery-flow-section:nth-child(3) .delivery-flow-section-title small { color: #fcd34d; }
/* Flow 4 ‚Äì ‡¶¨‡ßá‡¶ó‡ßÅ‡¶®‡¶ø */
.delivery-flow-section:nth-child(4) { background: #4c1d95; border-color: #a78bfa; }
.delivery-flow-section:nth-child(4) .delivery-flow-section-title { color: #e9d5ff; }
.delivery-flow-section:nth-child(4) .delivery-flow-section-title .flow-num { background: #a78bfa; color: #2e1065; }
.delivery-flow-section:nth-child(4) .delivery-flow-section-title small { color: #c4b5fd; }
/* Flow 5+ ‚Äì ‡¶∏‡¶æ‡¶Ø‡¶º‡¶æ‡¶® */
.delivery-flow-section:nth-child(n+5) { background: #164e63; border-color: #06b6d4; }
.delivery-flow-section:nth-child(n+5) .delivery-flow-section-title { color: #a5f3fc; }
.delivery-flow-section:nth-child(n+5) .delivery-flow-section-title .flow-num { background: #06b6d4; color: #083344; }
.delivery-flow-section:nth-child(n+5) .delivery-flow-section-title small { color: #67e8f9; }
/* Delivery Flow Set ‚Äì ‡¶≠‡ßá‡¶§‡¶∞‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∞‡¶ô ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ */
.delivery-flow-panel .delivery-flow-cloned-card {
    background: radial-gradient(circle at top left, rgba(55,65,81,0.95), rgba(15,23,42,0.98)) !important;
    border: 1px solid rgba(148,163,184,0.5) !important;
    box-shadow: 0 6px 18px rgba(15,23,42,0.7) !important;
}
.delivery-flow-section:nth-child(1) .delivery-flow-cloned-card {
    border-left: 4px solid #22c55e !important;
    box-shadow: 0 6px 18px rgba(15,23,42,0.7), 0 0 0 1px rgba(34,197,94,0.25) !important;
}
.delivery-flow-section:nth-child(1) .delivery-flow-cloned-card .list-entry-pack-number { color: #86efac !important; }
.delivery-flow-section:nth-child(1) .delivery-flow-cloned-card .list-datetime-admin { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%) !important; border-color: #22c55e !important; color: #fff !important; }
.delivery-flow-section:nth-child(1) .delivery-flow-cloned-card .list-username { color: #86efac !important; }
.delivery-flow-section:nth-child(2) .delivery-flow-cloned-card {
    border-left: 4px solid #14b8a6 !important;
    box-shadow: 0 6px 18px rgba(15,23,42,0.7), 0 0 0 1px rgba(20,184,166,0.25) !important;
}
.delivery-flow-section:nth-child(2) .delivery-flow-cloned-card .list-entry-pack-number { color: #5eead4 !important; }
.delivery-flow-section:nth-child(2) .delivery-flow-cloned-card .list-datetime-admin { background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%) !important; border-color: #14b8a6 !important; color: #fff !important; }
.delivery-flow-section:nth-child(2) .delivery-flow-cloned-card .list-username { color: #5eead4 !important; }
.delivery-flow-section:nth-child(3) .delivery-flow-cloned-card {
    border-left: 4px solid #f59e0b !important;
    box-shadow: 0 6px 18px rgba(15,23,42,0.7), 0 0 0 1px rgba(245,158,11,0.25) !important;
}
.delivery-flow-section:nth-child(3) .delivery-flow-cloned-card .list-entry-pack-number { color: #fcd34d !important; }
.delivery-flow-section:nth-child(3) .delivery-flow-cloned-card .list-datetime-admin { background: linear-gradient(135deg, #d97706 0%, #b45309 100%) !important; border-color: #f59e0b !important; color: #fff !important; }
.delivery-flow-section:nth-child(3) .delivery-flow-cloned-card .list-username { color: #fcd34d !important; }
.delivery-flow-section:nth-child(4) .delivery-flow-cloned-card {
    border-left: 4px solid #a78bfa !important;
    box-shadow: 0 6px 18px rgba(15,23,42,0.7), 0 0 0 1px rgba(167,139,250,0.25) !important;
}
.delivery-flow-section:nth-child(4) .delivery-flow-cloned-card .list-entry-pack-number { color: #c4b5fd !important; }
.delivery-flow-section:nth-child(4) .delivery-flow-cloned-card .list-datetime-admin { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%) !important; border-color: #a78bfa !important; color: #fff !important; }
.delivery-flow-section:nth-child(4) .delivery-flow-cloned-card .list-username { color: #c4b5fd !important; }
.delivery-flow-section:nth-child(n+5) .delivery-flow-cloned-card {
    border-left: 4px solid #06b6d4 !important;
    box-shadow: 0 6px 18px rgba(15,23,42,0.7), 0 0 0 1px rgba(6,182,212,0.25) !important;
}
.delivery-flow-section:nth-child(n+5) .delivery-flow-cloned-card .list-entry-pack-number { color: #67e8f9 !important; }
.delivery-flow-section:nth-child(n+5) .delivery-flow-cloned-card .list-datetime-admin { background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%) !important; border-color: #06b6d4 !important; color: #fff !important; }
.delivery-flow-section:nth-child(n+5) .delivery-flow-cloned-card .list-username { color: #67e8f9 !important; }
.delivery-flow-panel .delivery-flow-cloned-card .list-section h4 { color: #9ca3af !important; }
.delivery-flow-panel .delivery-flow-cloned-card .list-section { background: transparent !important; border: none !important; padding: 0 !important; }
.delivery-flow-panel .delivery-flow-cloned-card .list-section-content { background: transparent !important; color: #d1d5db !important; }
.delivery-flow-panel .delivery-flow-cloned-card .list-entry .content { color: #d1d5db !important; }
.time-flow-label-badge,
.time-flow-status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 24px;
    min-height: 24px;
    box-sizing: border-box;
    line-height: 1;
}
.time-flow-label-badge {
    margin-left: 8px;
    padding: 0 8px;
    border-radius: 4px;
    background: rgba(20,184,166,0.2);
    border: 1px solid rgba(94,234,212,0.5);
    color: #5eead4;
    font-size: 0.7rem;
    font-weight: 600;
}
.time-flow-status-badge {
    margin-left: 6px;
    padding: 0 10px;
    border-radius: 4px;
    background: linear-gradient(135deg, rgba(20,184,166,0.3) 0%, rgba(45,212,191,0.25) 100%);
    border: 1px solid rgba(94,234,212,0.55);
    color: #99f6e4;
    font-size: 0.72rem;
    font-weight: 600;
}
.flow-consolidated-selector { display: none; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 6px; }
.flow-consolidated-option { border-radius: 9999px; border: 1px solid rgba(55,65,81,0.9); background: rgba(31,41,55,0.9); color: #e5e7eb; font-size: 0.78rem; padding: 4px 10px; cursor: pointer; }
.flow-consolidated-option.active { border-color: rgba(37,99,235,0.9); background: rgba(37,99,235,0.2); }
@media (max-width: 600px) { .time-flow-row { align-items: flex-start; } .time-flow-name { min-width: 100%; } }
.notice-board textarea { width: 100%; padding: 8px 12px; border-radius: 8px; border: none; color: #1f2937; font-family: inherit; resize: vertical; min-height: 36px; max-height: 60px; font-size: 0.9rem; }
@media (max-width: 768px) {
    .admin-theme .container { padding: 0 16px; max-width: 100%; }
    .admin-header { flex-direction: column; align-items: flex-start; gap: 12px; }
    .filter-cards { grid-template-columns: 1fr; gap: 8px; }
    .filter-card { padding: 10px 12px; }
    .filter-card .count { font-size: 0.95rem; }
    .nav-cards { flex-direction: column; }
    .nav-card { padding: 16px; width: 100%; }
    .list-entry-actions { flex-direction: column; align-items: stretch; }
    .list-entry-actions .btn, .list-entry-actions a { text-align: center; }
}
@media (max-width: 700px) { .list-entry-sections { grid-template-columns: 1fr; } .total-actions-row { grid-template-columns: 1fr; } }
@media (max-width: 600px) { .list-entry { gap: 12px; padding: 16px; } .list-entry-header { flex-direction: column; } .list-entry-header-row { flex-direction: column; align-items: stretch; } .list-entry .actions { flex-wrap: wrap; } .notice-board { padding: 14px 16px !important; } .notice-board textarea { min-height: 70px; } }
@media (max-width: 400px) { .admin-brand h1 { font-size: 1rem; } .admin-brand .sub { font-size: 0.8rem; } .filter-card .count { font-size: 0.9rem; } }
{% endblock %}
{% block content %}
<div class="admin-theme">
<div class="container">
    <div class="admin-header">
        <div class="admin-brand">
            <span class="icon">üõí</span>
            <div>
                <h1>‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßã‡¶°</h1>
                <span class="sub">‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶®</span>
            </div>
        </div>
        <div class="admin-header-icons">
            <a href="{% url 'user_logout' %}" class="logout-btn" title="‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </a>
        </div>
    </div>

    <div class="notice-board" style="background: #374151; padding: 16px 20px; border-radius: 12px; margin-bottom: 24px;">
        <h3 style="color: white; margin: 0 0 12px 0; font-size: 1rem;">üìå ‡¶®‡ßã‡¶ü‡¶ø‡¶∏ ‡¶¨‡ßã‡¶∞‡ßç‡¶° (‡¶∏‡¶¨ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá)</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="notice">
            {{ notice_form.content }}
            <button type="submit" style="margin-top: 10px; padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer;">‡¶®‡ßã‡¶ü‡¶ø‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </form>
    </div>

    <div class="nav-cards">
        <a href="{% url 'user_directory' %}" class="nav-card">
            <div style="display: flex; align-items: center; gap: 16px;">
                <span class="nav-icon nav-icon-delivery" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                </span>
                <div class="nav-text">
                    <h3>Delivery Path Setup & Delivery Funnel</h3>
                    <p>‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∞‡¶æ‡¶∏‡ßç‡¶§‡¶æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                </div>
                {% if delivery_path_pending_count %}
                <span class="delivery-path-pending-badge">{{ delivery_path_pending_count }}</span>
                {% endif %}
            </div>
        </a>
        <a href="{% url 'user_profiles' %}" class="nav-card">
            <div style="display: flex; align-items: center; gap: 16px;">
                <span class="nav-icon nav-icon-user" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </span>
                <div class="nav-text">
                    <h3>User Profiles</h3>
                    <p>‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ó‡ßÅ‡¶≤‡ßá‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                </div>
            </div>
        </a>
    </div>

    <div class="list-entry-header-row">
        <h3 style="color: white; margin: 0;">‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
    </div>

    {% if filter_status == 'total' %}
    <div id="inlineConsolidatedPanel" class="inline-panel">
        <div class="inline-panel-header">
            <div class="inline-panel-title">üìã Consolidated List</div>
            <button type="button" class="inline-panel-back" data-target="consolidated">‚Üê Back</button>
        </div>
        <div id="flowConsolidatedSelector" class="flow-consolidated-selector"></div>
        <a href="{% url 'list_entry_consolidated_pdf' %}?filter={{ filter_status }}" class="pdf-btn">üìÑ ‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</a>
        {% if merged_items %}
        <div class="inline-merged-list">
            <ul>
                {% for item in merged_items %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <p class="inline-panel-empty">‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶®‡ßá‡¶á‡•§</p>
        {% endif %}
    </div>

    <div id="inlineUserViewPanel" class="inline-panel">
        <div class="inline-panel-header">
            <div class="inline-panel-title">üë• User View</div>
            <button type="button" class="inline-panel-back" data-target="user">‚Üê Back</button>
        </div>
        <div id="flowUserSelector" class="flow-consolidated-selector"></div>
        <p style="color: #9ca3af; margin: 0 0 12px 0; font-size: 0.9rem;">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá‡•§</p>
        {% if users_list %}
        <ul class="inline-user-list">
            {% for u in users_list %}
            <li class="inline-user-item">
                <span class="inline-user-click" tabindex="0">
                    <span class="name">{{ u.display_name }}</span>
                    <span class="inline-user-badge">{{ u.count }}</span>
                    <span class="inline-user-chevron">‚ñº</span>
                </span>
                <div class="inline-lists-dropdown">
                    {% for lst in u.lists %}
                    <div class="inline-list-item"{% if lst.created_at %} data-created="{{ lst.created_at|date:'c' }}"{% endif %}>
                        <div class="meta">
                            <a href="{% url 'user_profile_detail' u.user_id %}">{{ lst.list_id }}</a>
                                            ¬∑ <span class="inline-datetime">{{ lst.created_at|date_card }}</span>
                        </div>
                        <div class="inline-status-text{% if lst.status_note %} has-custom{% endif %}" data-default="{{ lst.status }}">{{ lst.status_note|default:lst.status }}</div>
                        <div class="content">{{ lst.ai_content|default:lst.content|default:"-"|linebreaksbr }}</div>
                    </div>
                    {% endfor %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="inline-panel-empty">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</p>
        {% endif %}
    </div>
    {% endif %}
    <div id="listCardsSection">
    {% if filter_status == 'total' %}
    <div class="total-actions-row">
        <button type="button" class="total-action-btn" id="deliveryFlowToggleBtn">
            Delivery Flow Set
            <span class="delivery-flow-total-badge" id="deliveryFlowTotalBadge">0</span>
        </button>
        <button type="button" class="total-action-btn" id="consolidatedToggleBtn">üìã Consolidated List</button>
        <button type="button" class="total-action-btn" id="userViewToggleBtn">üë§ User View</button>
    </div>
    <div class="delivery-flow-panel" id="deliveryFlowPanel" data-save-url="{% url 'save_delivery_flow' %}">
        <div class="delivery-flow-header">
            <div>
                <h4 class="delivery-flow-header-title">Delivery Flow Set</h4>
            </div>
            <button type="button" class="delivery-flow-btn" id="createTimeFlowBtn">Create New Flow</button>
        </div>
        <section class="delivery-flow-step-block delivery-flow-step-flows" id="flowSetStepBlock">
            <h5 class="delivery-flow-step-title">
                <span class="delivery-flow-step-num">‡ßß</span> ‡¶´‡ßç‡¶≤‡ßã ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                <button type="button" class="delivery-flow-step-toggle" id="flowSetStepToggle" aria-label="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß" title="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß">‚è∏</button>
            </h5>
            <div class="delivery-flow-step-body">
                <p class="delivery-flow-step-desc">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶´‡ßç‡¶≤‡ßã‡¶§‡ßá ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶ì ‡¶≤‡ßá‡¶¨‡ßá‡¶≤ ‡¶¶‡¶ø‡¶®; Send Order Status ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®‡•§ ‡¶∂‡ßá‡¶∑‡ßá Update ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                <div class="time-flow-list" id="timeFlowList">
                    <div class="time-flow-list-empty" id="timeFlowListEmpty">‡¶ï‡ßã‡¶®‡ßã ‡¶´‡ßç‡¶≤‡ßã ‡¶®‡ßá‡¶á‡•§ <strong>‡¶â‡¶™‡¶∞‡ßá‡¶∞ "Create New Flow" ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</strong></div>
                </div>
                <div class="delivery-flow-actions">
                    <button type="button" class="delivery-flow-btn" id="saveTimeFlowBtn">üíæ Update / ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>
        </section>
        <section class="delivery-flow-step-block delivery-flow-step-orders">
            <h5 class="delivery-flow-step-title"><span class="delivery-flow-step-num">‡ß®</span> ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶´‡ßç‡¶≤‡ßã ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</h5>
            <div class="delivery-flow-sections" id="deliveryFlowSections"></div>
        </section>
    </div>
    {% endif %}

    {% if filter_status == 'total' %}
    <div class="total-order-lists-section" id="totalOrderListsSection">
        <div class="total-order-lists-header delivery-flow-section-title">
            <span class="total-order-lists-title">TOTAL ORDER RECEIVED <span class="total-order-lists-badge" id="totalOrderListsBadge">{{ total_count }}</span></span>
            <button type="button" class="delivery-flow-section-toggle" id="totalOrderListsToggle" aria-label="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß" title="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß">‚è∏</button>
        </div>
        <div class="total-order-lists-body" id="totalOrderListsBody">
    {% endif %}
    {% if filter_status == 'delivered' %}
    <div class="filter-order-lists-section total-order-lists-section" id="deliveredOrderListsSection">
        <div class="total-order-lists-header delivery-flow-section-title">
            <span class="total-order-lists-title">DELIVERED <span class="total-order-lists-badge" id="deliveredOrderListsBadge">{{ delivered_count }}</span></span>
            <button type="button" class="delivery-flow-section-toggle" id="deliveredOrderListsToggle" aria-label="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß" title="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß">‚è∏</button>
        </div>
        <div class="total-order-lists-body" id="deliveredOrderListsBody">
    {% endif %}
    {% if filter_status == 'declined' %}
    <div class="filter-order-lists-section total-order-lists-section" id="declinedOrderListsSection">
        <div class="total-order-lists-header delivery-flow-section-title">
            <span class="total-order-lists-title">CANCELLED <span class="total-order-lists-badge" id="declinedOrderListsBadge">{{ declined_count }}</span></span>
            <button type="button" class="delivery-flow-section-toggle" id="declinedOrderListsToggle" aria-label="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß" title="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß">‚è∏</button>
        </div>
        <div class="total-order-lists-body" id="declinedOrderListsBody">
    {% endif %}
    {% if lists %}
    {% for list in lists %}
    <div class="list-entry {% if list.status == 'delivered' %}list-entry-delivered{% endif %}" data-list-pk="{{ list.pk }}" data-status="{{ list.status }}" {% if list.created_at %}data-created="{{ list.created_at|date:'c' }}"{% endif %}>
        <div class="list-entry-top-row">
            <div class="list-entry-pack-number">{{ list.list_id }} <span class="list-datetime-admin">{{ list.created_at|date_card }}</span></div>
        </div>
        <div class="list-entry-header">
            <div style="flex: 1;">
                <div class="user-date">
                    <a href="{% url 'user_profile_detail' list.family_id %}" class="list-avatar-link" title="View profile">{% if list.user_avatar_url %}
                        <img src="{{ list.user_avatar_url }}" alt="" class="list-user-avatar">
                        {% else %}
                        <span class="list-user-avatar-placeholder">üë§</span>
                        {% endif %}
                    </a>
                    <a href="{% url 'user_profile_detail' list.family_id %}" class="list-username" title="View profile">{{ list.user_display_name }}</a>
                </div>
            </div>
            <div class="actions">
                {% if filter_status == 'total' or filter_status == 'declined' %}
                <a href="{% url 'admin_edit_list' list.pk %}?filter={{ filter_status }}" class="action-icon action-edit" title="Edit">‚úèÔ∏è</a>
                {% endif %}
                {% if list.status == 'declined' %}
                <a href="{% url 'restore_list' list.pk %}" class="action-icon action-restore" title="Restore to Total">‚ôªÔ∏è</a>
                {% endif %}
                <a href="{% url 'admin_delete_list' list.pk %}" class="action-icon action-delete" title="Delete" onclick="return confirm('‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?');">üóëÔ∏è</a>
            </div>
        </div>
        <div class="list-entry-sections">
            <div class="list-section" title="Original list (as submitted)">
                <h4>‡¶Æ‡ßÇ‡¶≤ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶Ø‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßá)</h4>
                <div class="list-section-content">{{ list.content|default:"-"|linebreaksbr }}</div>
            </div>
            <div class="list-section" title="AI list (click generate to regenerate)">
                <h4>AI ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü)</h4>
                <div class="list-section-content ai-content" id="ai-content-{{ list.pk }}">{% if list.ai_content %}{{ list.ai_content|linebreaksbr }}{% else %}‚Äî ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®{% endif %}</div>
                <button type="button" class="ai-generate-btn" data-list-pk="{{ list.pk }}" data-ai-url="{% url 'ai_generate_list' list.pk %}" title="Generate with AI">‚ú® AI ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü</button>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="no-lists">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</div>
    {% endif %}
    {% if filter_status == 'total' %}
        </div>
    </div>
    <div class="filter-order-lists-section total-order-lists-section" id="declinedOrderListsSection">
        <div class="total-order-lists-header delivery-flow-section-title">
            <span class="total-order-lists-title">CANCELLED <span class="total-order-lists-badge" id="declinedOrderListsBadge">{{ declined_count }}</span></span>
            <button type="button" class="delivery-flow-section-toggle" id="declinedOrderListsToggle" aria-label="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß" title="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß">‚è∏</button>
        </div>
        <div class="total-order-lists-body" id="declinedOrderListsBody">
        {% for list in declined_lists %}
        <div class="list-entry" data-list-pk="{{ list.pk }}" data-status="declined" {% if list.created_at %}data-created="{{ list.created_at|date:'c' }}"{% endif %}>
            <div class="list-entry-top-row">
                <div class="list-entry-pack-number">{{ list.list_id }} <span class="list-datetime-admin">{{ list.created_at|date_card }}</span></div>
            </div>
            <div class="list-entry-header">
                <div style="flex: 1;">
                    <div class="user-date">
                        <a href="{% url 'user_profile_detail' list.family_id %}" class="list-avatar-link" title="View profile">{% if list.user_avatar_url %}
                            <img src="{{ list.user_avatar_url }}" alt="" class="list-user-avatar">
                            {% else %}
                            <span class="list-user-avatar-placeholder">üë§</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'user_profile_detail' list.family_id %}" class="list-username" title="View profile">{{ list.user_display_name }}</a>
                    </div>
                </div>
                <div class="actions">
                    <a href="{% url 'admin_edit_list' list.pk %}?filter=total" class="action-icon action-edit" title="Edit">‚úèÔ∏è</a>
                    <a href="{% url 'restore_list' list.pk %}" class="action-icon action-restore" title="Restore to Total">‚ôªÔ∏è</a>
                    <a href="{% url 'admin_delete_list' list.pk %}" class="action-icon action-delete" title="Delete" onclick="return confirm('‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?');">üóëÔ∏è</a>
                </div>
            </div>
            <div class="list-entry-sections">
                <div class="list-section" title="Original list (as submitted)">
                    <h4>‡¶Æ‡ßÇ‡¶≤ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶Ø‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßá)</h4>
                    <div class="list-section-content">{{ list.content|default:"-"|linebreaksbr }}</div>
                </div>
                <div class="list-section" title="AI list (click generate to regenerate)">
                    <h4>AI ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü)</h4>
                    <div class="list-section-content ai-content" id="ai-content-{{ list.pk }}">{% if list.ai_content %}{{ list.ai_content|linebreaksbr }}{% else %}‚Äî ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®{% endif %}</div>
                    <button type="button" class="ai-generate-btn" data-list-pk="{{ list.pk }}" data-ai-url="{% url 'ai_generate_list' list.pk %}" title="Generate with AI">‚ú® AI ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü</button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-lists">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</div>
        {% endfor %}
        </div>
    </div>
    <div class="filter-order-lists-section total-order-lists-section" id="deliveredOrderListsSection">
        <div class="total-order-lists-header delivery-flow-section-title">
            <span class="total-order-lists-title">DELIVERED <span class="total-order-lists-badge" id="deliveredOrderListsBadge">{{ delivered_count }}</span></span>
            <button type="button" class="delivery-flow-section-toggle" id="deliveredOrderListsToggle" aria-label="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß" title="‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß">‚è∏</button>
        </div>
        <div class="total-order-lists-body" id="deliveredOrderListsBody">
        {% for list in delivered_lists %}
        <div class="list-entry list-entry-delivered" data-list-pk="{{ list.pk }}" data-status="delivered" {% if list.created_at %}data-created="{{ list.created_at|date:'c' }}"{% endif %}>
            <div class="list-entry-top-row">
                <div class="list-entry-pack-number">{{ list.list_id }} <span class="list-datetime-admin">{{ list.created_at|date_card }}</span></div>
            </div>
            <div class="list-entry-header">
                <div style="flex: 1;">
                    <div class="user-date">
                        <a href="{% url 'user_profile_detail' list.family_id %}" class="list-avatar-link" title="View profile">{% if list.user_avatar_url %}
                            <img src="{{ list.user_avatar_url }}" alt="" class="list-user-avatar">
                            {% else %}
                            <span class="list-user-avatar-placeholder">üë§</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'user_profile_detail' list.family_id %}" class="list-username" title="View profile">{{ list.user_display_name }}</a>
                    </div>
                </div>
                <div class="actions">
                    <a href="{% url 'admin_edit_list' list.pk %}?filter=total" class="action-icon action-edit" title="Edit">‚úèÔ∏è</a>
                    <a href="{% url 'admin_delete_list' list.pk %}" class="action-icon action-delete" title="Delete" onclick="return confirm('‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?');">üóëÔ∏è</a>
                </div>
            </div>
            <div class="list-entry-sections">
                <div class="list-section" title="Original list (as submitted)">
                    <h4>‡¶Æ‡ßÇ‡¶≤ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶Ø‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßá)</h4>
                    <div class="list-section-content">{{ list.content|default:"-"|linebreaksbr }}</div>
                </div>
                <div class="list-section" title="AI list (click generate to regenerate)">
                    <h4>AI ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü)</h4>
                    <div class="list-section-content ai-content" id="ai-content-{{ list.pk }}">{% if list.ai_content %}{{ list.ai_content|linebreaksbr }}{% else %}‚Äî ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®{% endif %}</div>
                    <button type="button" class="ai-generate-btn" data-list-pk="{{ list.pk }}" data-ai-url="{% url 'ai_generate_list' list.pk %}" title="Generate with AI">‚ú® AI ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü</button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-lists">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</div>
        {% endfor %}
        </div>
    </div>
    {% endif %}
    {% if filter_status == 'delivered' %}
        </div>
    </div>
    {% endif %}
    {% if filter_status == 'declined' %}
        </div>
    </div>
    {% endif %}
</div>
</div>
</div>
{{ delivery_flows|json_script:"delivery-flow-json" }}
{{ send_status_presets|json_script:"send-status-presets-json" }}

<style>
.list-avatar-link { display: inline-flex; align-items: center; flex-shrink: 0; }
.list-user-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
.list-user-avatar-placeholder { width: 36px; height: 36px; border-radius: 50%; background: #4b5563; color: #9ca3af; display: inline-flex; align-items: center; justify-content: center; font-size: 1.1rem; }
.list-username { color: #60a5fa; font-weight: 600; text-decoration: none; }
.list-username:hover { color: #93c5fd; text-decoration: underline; }
.list-meta { font-size: 0.85rem; color: #9ca3af; }
.list-status-badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; margin-left: 8px; }
.list-status-approved { background: #2563eb; color: white; }
.list-status-chip { display: inline-flex; align-items: center; justify-content: center; padding: 6px 14px; border-radius: 8px; font-size: 0.85rem; font-weight: 700; line-height: 1.2; min-height: 28px; box-sizing: border-box; }
.list-status-chip-delivered { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; box-shadow: 0 2px 4px rgba(5,150,105,0.3); }
.admin-list-content { display: block; color: #d1d5db; margin-top: 8px; white-space: pre-wrap; font-size: 0.95rem; }
.comment-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
.comment-modal-overlay.active { display: flex; }
.comment-modal-box { background: #1f2937; border-radius: 16px; width: 100%; max-width: 560px; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
.comment-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #374151; }
.comment-modal-header h3 { margin: 0; font-size: 1.1rem; color: white; }
.comment-modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af; line-height: 1; padding: 0 8px; }
.comment-modal-close:hover { color: white; }
.comment-modal-iframe { width: 100%; height: 60vh; min-height: 400px; border: none; display: block; }
</style>
<div id="adminCommentModal" class="comment-modal-overlay">
    <div class="comment-modal-box">
        <div class="comment-modal-header">
            <h3>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</h3>
            <button type="button" class="comment-modal-close" aria-label="‡¶¨‡¶®‡ßç‡¶ß">&times;</button>
        </div>
        <iframe id="adminCommentIframe" class="comment-modal-iframe" src="about:blank"></iframe>
    </div>
</div>
<script>
(function() {
    var SCROLL_KEY = 'mgmt_dashboard_scroll';
    var saved = sessionStorage.getItem(SCROLL_KEY);
    if (saved !== null) {
        sessionStorage.removeItem(SCROLL_KEY);
        var y = parseInt(saved, 10);
        if (!isNaN(y) && y > 0) {
            function doScroll() { window.scrollTo(0, y); }
            if (document.readyState === 'complete') setTimeout(doScroll, 0);
            else window.addEventListener('load', doScroll);
        }
    }
    document.querySelectorAll('.filter-card').forEach(function(a) {
        a.addEventListener('click', function() { sessionStorage.setItem(SCROLL_KEY, String(window.scrollY)); });
    });
    document.querySelectorAll('.list-entry .action-icon').forEach(function(a) {
        a.addEventListener('click', function() { sessionStorage.setItem(SCROLL_KEY, String(window.scrollY)); });
    });
})();

// Delivered / Declined filter active thakle click = show/hide (toggle)
(function() {
    function attachToggle(cardId, hideInitially) {
        var card = document.getElementById(cardId);
        if (!card) return;
        // Shudhu oi filter already active thakle toggle korbo
        if (!card.classList.contains('active')) return;

        var targets = Array.prototype.slice.call(
            document.querySelectorAll('.list-entry, .no-lists')
        );
        if (!targets.length) return;

        var visible = !hideInitially;

        // Jodi hideInitially true hoy (Total er jonno) -> page load e list gula off thakbe
        if (hideInitially) {
            targets.forEach(function(el) {
                el.style.display = 'none';
            });
        }

        card.addEventListener('click', function(e) {
            // Same page e thakbo, shudhu show/hide korbo
            e.preventDefault();
            visible = !visible;
            targets.forEach(function(el) {
                el.style.display = visible ? '' : 'none';
            });
        });
    }

})();

(function() {
    var TOTAL_ORDER_LISTS_STORAGE_KEY = 'eayShop_totalOrderLists_collapsed';
    var totalOrderListsToggle = document.getElementById('totalOrderListsToggle');
    var totalOrderListsSection = document.getElementById('totalOrderListsSection');
    if (!totalOrderListsToggle || !totalOrderListsSection) return;
    try {
        if (localStorage.getItem(TOTAL_ORDER_LISTS_STORAGE_KEY) === 'true') {
            totalOrderListsSection.classList.add('collapsed');
            totalOrderListsToggle.innerHTML = '‚ñ∂';
        }
    } catch (e) {}
    totalOrderListsToggle.addEventListener('click', function() {
        totalOrderListsSection.classList.toggle('collapsed');
        var isCollapsed = totalOrderListsSection.classList.contains('collapsed');
        totalOrderListsToggle.innerHTML = isCollapsed ? '‚ñ∂' : '‚è∏';
        try {
            localStorage.setItem(TOTAL_ORDER_LISTS_STORAGE_KEY, isCollapsed ? 'true' : 'false');
        } catch (e) {}
    });
})();

(function() {
    function initFilterListsToggle(sectionId, toggleId, storageKey) {
        var section = document.getElementById(sectionId);
        var toggle = document.getElementById(toggleId);
        if (!section || !toggle) return;
        try {
            if (localStorage.getItem(storageKey) === 'true') {
                section.classList.add('collapsed');
                toggle.innerHTML = '‚ñ∂';
            }
        } catch (e) {}
        toggle.addEventListener('click', function() {
            section.classList.toggle('collapsed');
            var isCollapsed = section.classList.contains('collapsed');
            toggle.innerHTML = isCollapsed ? '‚ñ∂' : '‚è∏';
            try { localStorage.setItem(storageKey, isCollapsed ? 'true' : 'false'); } catch (e) {}
        });
    }
    initFilterListsToggle('deliveredOrderListsSection', 'deliveredOrderListsToggle', 'eayShop_deliveredOrderLists_collapsed');
    initFilterListsToggle('declinedOrderListsSection', 'declinedOrderListsToggle', 'eayShop_declinedOrderLists_collapsed');
})();

// Send Order Status UI removed

(function() {
    var toggleBtn = document.getElementById('deliveryFlowToggleBtn');
    var panel = document.getElementById('deliveryFlowPanel');
    var createBtn = document.getElementById('createTimeFlowBtn');
    var listEl = document.getElementById('timeFlowList');
    var saveBtn = document.getElementById('saveTimeFlowBtn');
    var sectionsEl = document.getElementById('deliveryFlowSections');
    var saveUrl = panel ? panel.getAttribute('data-save-url') : '';
    var csrfToken = (document.querySelector('input[name=\"csrfmiddlewaretoken\"]') || {}).value || '';
    var initialFlows = [];
    try {
        var jsonEl = document.getElementById('delivery-flow-json');
        if (jsonEl && jsonEl.textContent) {
            initialFlows = JSON.parse(jsonEl.textContent);
        }
    } catch (e) {
        initialFlows = [];
    }
    if (!toggleBtn || !panel || !createBtn || !listEl || !saveBtn || !sectionsEl) return;

    var flowCount = 0;
    var COLLAPSED_STORAGE_KEY = 'eayShop_deliveryFlow_collapsed';

    function getSavedCollapsedState() {
        try {
            var raw = localStorage.getItem(COLLAPSED_STORAGE_KEY);
            if (raw) return JSON.parse(raw);
        } catch (e) {}
        return {};
    }

    function saveCollapsedState() {
        var sections = sectionsEl.querySelectorAll('.delivery-flow-section');
        var state = {};
        for (var i = 0; i < sections.length; i++) {
            state[i] = sections[i].classList.contains('collapsed');
        }
        try {
            localStorage.setItem(COLLAPSED_STORAGE_KEY, JSON.stringify(state));
        } catch (e) {}
    }

    function getStatusPresets() {
        try {
            var script = document.getElementById('send-status-presets-json');
            if (!script || !script.textContent) return [];
            var vals = JSON.parse(script.textContent);
            return Array.isArray(vals) ? vals : [];
        } catch (e) {
            return [];
        }
    }

    function saveStatusPresetsFromDOM() {
        try {
            var all = new Set();
            var selects = listEl.querySelectorAll('.time-flow-status-select');
            selects.forEach(function(sel) {
                Array.prototype.slice.call(sel.options).forEach(function(opt) {
                    var v = (opt.value || '').trim();
                    if (v) all.add(v);
                });
            });
            var listArr = Array.from(all);
            var csrfToken = (document.querySelector('input[name="csrfmiddlewaretoken"]') || {}).value || '';
            var formData = new FormData();
            formData.append('presets', JSON.stringify(listArr));
            fetch("{% url 'save_send_status_presets' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                },
                body: formData,
            }).then(function(resp) {
                return resp.ok ? resp.json() : null;
            }).then(function(data) {
                if (!data || !data.success) return;
                // update in-page JSON so newly created rows also see latest presets
                var script = document.getElementById('send-status-presets-json');
                if (script) {
                    script.textContent = JSON.stringify(listArr);
                }
            }).catch(function() {
                // ignore network errors for now
            });
        } catch (e) {
            // ignore errors
        }
    }

    function createRow(initial) {
        flowCount += 1;
        var row = document.createElement('div');
        row.className = 'time-flow-row';
        var presets = getStatusPresets();

        row.innerHTML =
            '<div class="time-flow-name">Flow ' + flowCount + '<span class="time-flow-count">0</span></div>' +
            '<div class="time-flow-fields">' +
                '<div class="time-flow-field">' +
                    '<label>Start Time</label>' +
                    '<input type="time" name="flow_' + flowCount + '_start">' +
                '</div>' +
                '<span class="time-flow-separator">to</span>' +
                '<div class="time-flow-field">' +
                    '<label>End Time</label>' +
                    '<input type="time" name="flow_' + flowCount + '_end">' +
                '</div>' +
                '<span class="time-flow-separator">=</span>' +
                '<div class="time-flow-field">' +
                    '<label>‡¶ï‡ßã‡¶® ‡¶∏‡¶Æ‡ßü?</label>' +
                    '<input type="text" name="flow_' + flowCount + '_label">' +
                '</div>' +
                '<button type="button" class="time-flow-icon-btn time-flow-delete-btn" title="Delete flow">üóëÔ∏è</button>' +
                '<div class="time-flow-field time-flow-status-block">' +
                    '<label>Send Order Status</label>' +
                    '<div class="time-flow-status-row">' +
                        '<select name="flow_' + flowCount + '_status" class="time-flow-status-select"></select>' +
                        '<button type="button" class="time-flow-status-create-btn flow-status-pill">+ Create New</button>' +
                        '<input type="text" name="flow_status_custom" placeholder="Custom status" class="time-flow-status-input flow-status-pill" style="display:none;" />' +
                        '<button type="button" class="time-flow-status-save-btn flow-status-pill">Save</button>' +
                        '<button type="button" class="time-flow-status-delete-btn flow-status-pill">Delete</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        listEl.appendChild(row);
        var emptyEl = document.getElementById('timeFlowListEmpty');
        if (emptyEl) emptyEl.style.display = 'none';

        // Populate status dropdown from saved presets (or default Approved)
        var select = row.querySelector('.time-flow-status-select');
        if (select) {
            var presetsList = presets && presets.length ? presets : ['Approved'];
            presetsList.forEach(function(txt, idx) {
                var opt = document.createElement('option');
                opt.value = txt;
                opt.text = txt;
                select.appendChild(opt);
            });
        }
        if (initial) {
            var sIn = row.querySelector('input[name$=\"_start\"]');
            var eIn = row.querySelector('input[name$=\"_end\"]');
            var lIn = row.querySelector('input[name$=\"_label\"]');
            if (sIn && initial.start) sIn.value = initial.start;
            if (eIn && initial.end) eIn.value = initial.end;
            if (lIn && initial.label) lIn.value = initial.label;
            var statusText = (initial.statusText || '').trim();
            if (statusText && select) {
                for (var i = 0; i < select.options.length; i++) {
                    if ((select.options[i].text || select.options[i].value) === statusText) {
                        select.selectedIndex = i;
                        break;
                    }
                }
                if (select.selectedIndex < 0) {
                    var opt = document.createElement('option');
                    opt.value = statusText;
                    opt.text = statusText;
                    select.appendChild(opt);
                    select.selectedIndex = select.options.length - 1;
                }
            }
        }
        updateSaveVisibility();
        renumberFlows();
    }

    function updateSaveVisibility() {
        var hasRows = !!listEl.querySelector('.time-flow-row');
        saveBtn.parentElement.style.display = hasRows ? 'flex' : 'none';
    }

    function renumberFlows() {
        var rows = listEl.querySelectorAll('.time-flow-row');
        rows.forEach(function(row, idx) {
            var nameEl = row.querySelector('.time-flow-name');
            if (nameEl) {
                nameEl.textContent = 'Flow ' + (idx + 1);
            }
        });
    }

    function collectFlows() {
        var rows = listEl.querySelectorAll('.time-flow-row');
        var flows = [];
        rows.forEach(function(row, idx) {
            var startInput = row.querySelector('input[name$="_start"]');
            var endInput = row.querySelector('input[name$="_end"]');
            var labelInput = row.querySelector('input[name$="_label"]');
            var statusSelect = row.querySelector('.time-flow-status-select');
            var startVal = startInput ? (startInput.value || '').trim() : '';
            var endVal = endInput ? (endInput.value || '').trim() : '';
            var labelVal = labelInput ? (labelInput.value || '').trim() : '';
            var statusText = '';
            if (statusSelect && statusSelect.options[statusSelect.selectedIndex]) {
                statusText = (statusSelect.options[statusSelect.selectedIndex].text || statusSelect.value || '').trim();
            }
            if (startVal && endVal && labelVal) {
                flows.push({
                    name: 'Flow ' + (idx + 1),
                    start: startVal,
                    end: endVal,
                    label: labelVal,
                    statusText: statusText || 'Approved',
                    rowIndex: idx
                });
            }
        });
        return flows;
    }

    function parseTimeToMinutes(t) {
        if (!t) return null;
        var parts = t.split(':');
        if (parts.length < 2) return null;
        var h = parseInt(parts[0], 10);
        var m = parseInt(parts[1], 10);
        if (isNaN(h) || isNaN(m)) return null;
        return h * 60 + m;
    }

    function getListData() {
        var nodes = Array.prototype.slice.call(document.querySelectorAll('.list-entry'));
        return nodes.map(function(node) {
            var createdIso = node.getAttribute('data-created') || '';
            var createdMinutes = null;
            if (createdIso) {
                var d = new Date(createdIso);
                if (!isNaN(d.getTime())) {
                    createdMinutes = d.getHours() * 60 + d.getMinutes();
                }
            }
            var userEl = node.querySelector('.list-username');
            var timeEl = node.querySelector('.list-datetime-admin');
            return {
                el: node,
                pk: node.getAttribute('data-list-pk') || '',
                user: userEl ? userEl.textContent.trim() : '',
                createdDisplay: timeEl ? timeEl.textContent.trim() : '',
                createdMinutes: createdMinutes
            };
        });
    }

    function formatTime12(t) {
        if (!t) return '';
        var parts = t.split(':');
        if (parts.length < 2) return t;
        var h = parseInt(parts[0], 10);
        var m = parts[1];
        if (isNaN(h)) return t;
        var ampm = h < 12 ? 'AM' : 'PM';
        var h12 = h % 12;
        if (h12 === 0) h12 = 12;
        return h12 + ':' + m + ' ' + ampm;
    }

    function renderSections(flows) {
        sectionsEl.innerHTML = '';
        var listData = getListData();
        var listDataForFlows = listData.filter(function(ld) {
            var s = ld.el.getAttribute('data-status') || '';
            return s !== 'delivered' && s !== 'declined';
        });

        // ‡¶∏‡¶¨ ‡¶´‡ßç‡¶≤‡ßã‡¶∞ count badge ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø (‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶∞‡ßã ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßá)
        var rows = listEl.querySelectorAll('.time-flow-row');
        var totalCount = 0;
        rows.forEach(function(row) {
            var startInput = row.querySelector('input[name$="_start"]');
            var endInput = row.querySelector('input[name$="_end"]');
            var labelInput = row.querySelector('input[name$="_label"]');
            var startVal = startInput ? (startInput.value || '').trim() : '';
            var endVal = endInput ? (endInput.value || '').trim() : '';
            var labelVal = labelInput ? (labelInput.value || '').trim() : '';
            var count = 0;
            if (startVal && endVal && labelVal) {
                var sMinRow = parseTimeToMinutes(startVal);
                var eMinRow = parseTimeToMinutes(endVal);
                if (sMinRow !== null && eMinRow !== null) {
                    count = listDataForFlows.filter(function(ld) {
                        return ld.createdMinutes !== null &&
                               ld.createdMinutes >= sMinRow &&
                               ld.createdMinutes <= eMinRow;
                    }).length;
                }
            }
            var countEl = row.querySelector('.time-flow-count');
            if (countEl) countEl.textContent = count;
            totalCount += count;
        });

        // Delivery Flow Set ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
        var totalBadge = document.getElementById('deliveryFlowTotalBadge');
        if (totalBadge) {
            totalBadge.textContent = totalCount;
        }

        // flows (valid ‡¶´‡ßç‡¶≤‡ßã) ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ‡¶®‡¶æ‡¶á
        flows.forEach(function(flow, idx) {
            var sMin = parseTimeToMinutes(flow.start);
            var eMin = parseTimeToMinutes(flow.end);
            if (sMin === null || eMin === null) return;
            if (!flow.label) return;
            var matched = listDataForFlows.filter(function(ld) {
                return ld.createdMinutes !== null &&
                       ld.createdMinutes >= sMin &&
                       ld.createdMinutes <= eMin;
            });
            /* ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá‡¶ì ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶á ‚Äì ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ + ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® + ‡¶®‡¶æ‡¶Æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶∏‡¶¨‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º */
            var savedState = getSavedCollapsedState();
            var isCollapsed = savedState[idx] !== undefined ? savedState[idx] : true;
            var sec = document.createElement('div');
            sec.className = 'delivery-flow-section' + (isCollapsed ? ' collapsed' : '');
            var title = document.createElement('div');
            title.className = 'delivery-flow-section-title';
            var left = document.createElement('span');
            left.textContent = flow.label;
            var numSpan = document.createElement('span');
            numSpan.className = 'flow-num';
            numSpan.textContent = idx + 1;
            var statusSelect = document.createElement('select');
            statusSelect.className = 'delivery-flow-section-status-select';
            statusSelect.setAttribute('aria-label', 'Send Order Status');
            var presetsList = getStatusPresets();
            if (!presetsList || !presetsList.length) presetsList = ['Approved'];
            presetsList.forEach(function(txt) {
                var opt = document.createElement('option');
                opt.value = txt;
                opt.textContent = txt;
                statusSelect.appendChild(opt);
            });
            var currentStatus = (flow.statusText || 'Approved').trim();
            if (currentStatus && !presetsList.includes(currentStatus)) {
                var opt = document.createElement('option');
                opt.value = currentStatus;
                opt.textContent = currentStatus;
                statusSelect.appendChild(opt);
            }
            statusSelect.value = currentStatus;
            var rowIndex = flow.rowIndex;
            statusSelect.addEventListener('change', function() {
                var rows = listEl.querySelectorAll('.time-flow-row');
                var row = rows[rowIndex];
                if (row) {
                    var rowSelect = row.querySelector('.time-flow-status-select');
                    if (rowSelect) {
                        if (!Array.prototype.find.call(rowSelect.options, function(o) { return o.value === statusSelect.value; })) {
                            var o = document.createElement('option');
                            o.value = statusSelect.value;
                            o.textContent = statusSelect.value;
                            rowSelect.appendChild(o);
                        }
                        rowSelect.value = statusSelect.value;
                    }
                }
                var badges = sec.querySelectorAll('.time-flow-status-badge');
                badges.forEach(function(b) { b.textContent = statusSelect.value; });
                saveDeliveryFlow(true);
            });
            var toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'delivery-flow-section-toggle';
            toggleBtn.setAttribute('aria-label', '‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß');
            toggleBtn.innerHTML = isCollapsed ? '‚ñ∂' : '‚è∏';
            var right = document.createElement('small');
            right.textContent = formatTime12(flow.start) + ' ‚Äì ' + formatTime12(flow.end) + ' ‚Ä¢ ' + matched.length + ' order';
            title.appendChild(numSpan);
            title.appendChild(statusSelect);
            title.appendChild(toggleBtn);
            title.appendChild(left);
            title.appendChild(right);
            toggleBtn.addEventListener('click', function() {
                sec.classList.toggle('collapsed');
                toggleBtn.innerHTML = sec.classList.contains('collapsed') ? '‚ñ∂' : '‚è∏';
                saveCollapsedState();
            });
            var container = document.createElement('div');
            container.className = 'delivery-flow-section-body-cards';
            var statusToShowOnCards = (flow.statusText || 'Approved').trim();
            matched.forEach(function(ld) {
                var clone = ld.el.cloneNode(true);
                clone.classList.add('delivery-flow-cloned-card');
                // Send Order Status Pack number ‡¶è‡¶∞ ‡¶™‡¶æ‡¶∂‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶á
                var packEl = clone.querySelector('.list-entry-pack-number');
                if (packEl) {
                    packEl.appendChild(document.createTextNode(' '));
                    var statusBadge = document.createElement('span');
                    statusBadge.className = 'time-flow-status-badge';
                    statusBadge.textContent = statusToShowOnCards;
                    packEl.appendChild(statusBadge);
                }
                container.appendChild(clone);
            });
            sec.appendChild(title);
            sec.appendChild(container);
            sectionsEl.appendChild(sec);
        });

        // ‡¶Ü‡¶∏‡¶≤ list card ‡¶ó‡ßÅ‡¶≤‡ßã‡¶§‡ßá "‡¶ï‡ßã‡¶® ‡¶∏‡¶Æ‡¶Ø‡¶º?" badge + Pack number ‡¶è‡¶∞ ‡¶™‡¶æ‡¶∂‡ßá Send Order Status
        listData.forEach(function(ld) {
            var existingLabel = ld.el.querySelector('.time-flow-label-badge');
            if (existingLabel) existingLabel.remove();
            var packEl = ld.el.querySelector('.list-entry-pack-number');
            if (packEl) {
                var oldStatus = packEl.querySelector('.time-flow-status-badge');
                if (oldStatus) oldStatus.remove();
                var last = packEl.lastChild;
                if (last && last.nodeType === 3 && /^\s*$/.test(last.textContent)) last.remove();
            }
            var labelToShow = null;
            var statusToShow = null;
            var listStatus = ld.el.getAttribute('data-status') || '';
            if (listStatus === 'delivered') {
            } else if (listStatus === 'declined') {
                statusToShow = 'CANCELLED';
            } else {
                for (var f = 0; f < flows.length; f++) {
                    var flow = flows[f];
                    if (!flow.label) continue;
                    var sMin = parseTimeToMinutes(flow.start);
                    var eMin = parseTimeToMinutes(flow.end);
                    if (sMin === null || eMin === null) continue;
                    if (ld.createdMinutes !== null && ld.createdMinutes >= sMin && ld.createdMinutes <= eMin) {
                        labelToShow = flow.label;
                        statusToShow = (flow.statusText || 'Approved').trim();
                        break;
                    }
                }
            }
            if (packEl && labelToShow) {
                packEl.appendChild(document.createTextNode(' '));
                var badge = document.createElement('span');
                badge.className = 'time-flow-label-badge';
                badge.textContent = labelToShow;
                packEl.appendChild(badge);
            }
            if (packEl && statusToShow) {
                packEl.appendChild(document.createTextNode(' '));
                var statusBadge = document.createElement('span');
                statusBadge.className = 'time-flow-status-badge';
                statusBadge.textContent = statusToShow;
                packEl.appendChild(statusBadge);
            }
        });
    }

    var DELIVERY_FLOW_PANEL_STORAGE_KEY = 'eayShop_deliveryFlowPanel_open';
    toggleBtn.addEventListener('click', function() {
        var isOpen = panel.classList.contains('show');
        panel.classList.toggle('show', !isOpen);
        toggleBtn.classList.toggle('total-active', !isOpen);
        try {
            localStorage.setItem(DELIVERY_FLOW_PANEL_STORAGE_KEY, !isOpen ? 'true' : 'false');
        } catch (e) {}
    });
    try {
        if (localStorage.getItem(DELIVERY_FLOW_PANEL_STORAGE_KEY) === 'true') {
            panel.classList.add('show');
            toggleBtn.classList.add('total-active');
        }
    } catch (e) {}

    createBtn.addEventListener('click', function() {
        createRow();
        saveDeliveryFlow(true);
    });

    listEl.addEventListener('click', function(e) {
        var target = e.target;
        if (target.classList.contains('time-flow-delete-btn')) {
            var rowDel = target.closest('.time-flow-row');
            if (!rowDel) return;
            if (confirm('‡¶è‡¶á ‡¶´‡ßç‡¶≤‡ßã ‡¶∞‡ßã ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?')) {
                rowDel.remove();
                var emptyEl = document.getElementById('timeFlowListEmpty');
                if (emptyEl && !listEl.querySelector('.time-flow-row')) emptyEl.style.display = 'block';
                updateSaveVisibility();
                renumberFlows();
                var flows = collectFlows();
                if (!flows.length) {
                    sectionsEl.innerHTML = '';
                } else {
                    renderSections(flows);
                }
                saveDeliveryFlow(true);
            }
        } else if (target.classList.contains('time-flow-status-create-btn')) {
            var row = target.closest('.time-flow-row');
            if (!row) return;
            var input = row.querySelector('.time-flow-status-input');
            if (!input) return;
            // small visual feedback
            target.classList.add('pulse');
            setTimeout(function() { target.classList.remove('pulse'); }, 180);
            input.style.display = 'block';
            input.focus();
        } else if (target.classList.contains('time-flow-status-save-btn')) {
            var row = target.closest('.time-flow-row');
            if (!row) return;
            var select = row.querySelector('.time-flow-status-select');
            var input = row.querySelector('.time-flow-status-input');
            if (!select || !input) return;
            var txt = (input.value || '').trim();
            if (!txt) return;

            // visual effect on Save
            target.classList.add('pulse');
            setTimeout(function() { target.classList.remove('pulse'); }, 180);

            // Check if this text already exists as an option (by value)
            var exists = false;
            Array.prototype.slice.call(select.options).forEach(function(opt) {
                if ((opt.value || opt.text.replace(' ‚úï', '')) === txt) {
                    exists = true;
                }
            });
            if (!exists) {
                var opt = document.createElement('option');
                opt.value = txt;
                opt.text = txt;
                select.appendChild(opt);
            }
            select.value = txt;
            input.value = '';
            input.style.display = 'none';
            saveStatusPresetsFromDOM();
            saveDeliveryFlow(true);
        } else if (target.classList.contains('time-flow-status-delete-btn')) {
            var row = target.closest('.time-flow-row');
            if (!row) return;
            var select = row.querySelector('.time-flow-status-select');
            if (!select || select.options.length === 0) return;
            var idx = select.selectedIndex;
            if (idx < 0) return;
            var opt = select.options[idx];
            var label = opt.text || opt.value || '';
            if (!confirm('"' + label + '" status option ‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?')) return;
            // visual effect on Delete
            target.classList.add('pulse');
            setTimeout(function() { target.classList.remove('pulse'); }, 180);
            select.remove(idx);
            if (select.options.length > 0) {
                select.selectedIndex = 0;
            }
            saveStatusPresetsFromDOM();
            saveDeliveryFlow(true);
        }
    });

    var saveDeliveryFlowInputTimeout;
    listEl.addEventListener('input', function(e) {
        var target = e.target;
        if (target.tagName === 'INPUT' && (/_start$|_end$|_label$/).test(target.name || '')) {
            var flows = collectFlows();
            if (!flows.length) {
                sectionsEl.innerHTML = '';
                return;
            }
            renderSections(flows);
            clearTimeout(saveDeliveryFlowInputTimeout);
            saveDeliveryFlowInputTimeout = setTimeout(function() { saveDeliveryFlow(true); }, 400);
        }
    });

    function saveDeliveryFlow(silent) {
        var flows = collectFlows();
        renderSections(flows);
        if (!saveUrl) {
            if (!silent) alert('Delivery Flow ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
            return;
        }
        var body = 'flows=' + encodeURIComponent(JSON.stringify(flows));
        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: body
        }).then(function(r) {
            if (!r.ok) throw new Error('Failed to save');
            return r.json();
        }).then(function(data) {
            if (!data || !data.success) {
                alert('Delivery Flow ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }
            if (!silent) alert('Delivery Flow ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
        }).catch(function() {
            alert('Delivery Flow ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
        });
    }

    saveBtn.addEventListener('click', function() {
        saveDeliveryFlow(false);
    });

    listEl.addEventListener('change', function(e) {
        if (e.target.classList.contains('time-flow-status-select')) {
            saveDeliveryFlow(true);
        }
    });

    var FLOW_SET_STEP_STORAGE_KEY = 'eayShop_flowSetStepBlock_collapsed';
    var flowSetStepToggle = document.getElementById('flowSetStepToggle');
    var flowSetStepBlock = document.getElementById('flowSetStepBlock');
    if (flowSetStepToggle && flowSetStepBlock) {
        try {
            var saved = localStorage.getItem(FLOW_SET_STEP_STORAGE_KEY);
            if (saved === 'true') {
                flowSetStepBlock.classList.add('collapsed');
                flowSetStepToggle.innerHTML = '‚ñ∂';
            }
        } catch (e) {}
        flowSetStepToggle.addEventListener('click', function() {
            flowSetStepBlock.classList.toggle('collapsed');
            var isCollapsed = flowSetStepBlock.classList.contains('collapsed');
            flowSetStepToggle.innerHTML = isCollapsed ? '‚ñ∂' : '‚è∏';
            try {
                localStorage.setItem(FLOW_SET_STEP_STORAGE_KEY, isCollapsed ? 'true' : 'false');
            } catch (e) {}
        });
    }

    // Load any existing persisted flows into UI on first load
    if (initialFlows && initialFlows.length) {
        initialFlows.forEach(function(f) { createRow(f); });
        renumberFlows();
        renderSections(collectFlows());
        // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶°‡ßá‡¶á Delivery Flow view ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø
        // panel.classList.add('show');
        // toggleBtn.classList.add('total-active');
    }
})();
(function() {
    // Admin comment modal disabled (message icon hidden)
})();
function generateOne(btn, pk, url) {
    var container = document.getElementById('ai-content-' + pk);
    if (!container || !url) return Promise.resolve();
    btn.disabled = true;
    container.textContent = '‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
    container.classList.add('ai-loading');
    return fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            container.textContent = data.content || '‚Äî';
            container.classList.remove('ai-loading');
        })
        .catch(function() {
            container.textContent = '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
            container.classList.remove('ai-loading');
        })
        .finally(function() { btn.disabled = false; });
}

document.querySelectorAll('.ai-generate-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var pk = this.getAttribute('data-list-pk');
        var url = this.getAttribute('data-ai-url');
        generateOne(this, pk, url);
    });
});

// Bulk AI generate button removed

// Write Status JS removed
(function() {
    var consolidatedBtn = document.getElementById('consolidatedToggleBtn');
    var userViewBtn = document.getElementById('userViewToggleBtn');
    var consolidatedPanel = document.getElementById('inlineConsolidatedPanel');
    var userViewPanel = document.getElementById('inlineUserViewPanel');
    var listCardsSection = document.getElementById('listCardsSection');
    var flowSelector = document.getElementById('flowConsolidatedSelector');
    var flowUserSelector = document.getElementById('flowUserSelector');
    function updateVisibility() {
        var consolidatedShow = consolidatedPanel && consolidatedPanel.classList.contains('show');
        var userViewShow = userViewPanel && userViewPanel.classList.contains('show');
        if (listCardsSection) listCardsSection.style.display = (consolidatedShow || userViewShow) ? 'none' : '';
    }

    function getValidFlowsForConsolidation() {
        var rows = document.querySelectorAll('.time-flow-row');
        var flows = [];
        rows.forEach(function(row, idx) {
            var startInput = row.querySelector('input[name$="_start"]');
            var endInput = row.querySelector('input[name$="_end"]');
            var labelInput = row.querySelector('input[name$="_label"]');
            var startVal = startInput ? (startInput.value || '').trim() : '';
            var endVal = endInput ? (endInput.value || '').trim() : '';
            var labelVal = labelInput ? (labelInput.value || '').trim() : '';
            if (startVal && endVal && labelVal) {
                flows.push({
                    index: idx,
                    name: 'Flow ' + (idx + 1),
                    label: labelVal,
                    start: startVal,
                    end: endVal
                });
            }
        });
        return flows;
    }

    function stripNumberPrefix(line) {
        return line.replace(/^[0-9‡ß¶-‡ßØ]+[.\s]+/, '').trim();
    }

    /** ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ/‡¶á‡¶Ç) ‡¶π‡¶≤‡ßá ‡¶¨‡¶æ‡¶¶ ‚Äî ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶®‡ßá‡¶¨ ‡¶®‡¶æ */
    function isOnlyNumber(s) {
        if (!s || !s.trim()) return true;
        return /^[‡ß¶-‡ßØ0-9.\s]+$/.test(s.trim());
    }

    /** ‡¶è‡¶ï ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ï‡¶Æ‡¶æ ‡¶¨‡¶æ " ‡¶ì " ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≠‡¶æ‡¶ó ‚Äî kg/‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≠‡¶æ‡¶ó ‡¶π‡¶Ø‡¶º ‡¶®‡¶æ, ‡¶§‡¶æ‡¶á "‡ßß kg ‡¶Ü‡¶≤‡ßÅ" ‡¶è‡¶ï‡¶ü‡¶æ‡¶á ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ */
    function lineToSingleItems(line) {
        if (!line || !line.trim()) return [];
        var parts = line.split(/[,ÿå]+|\s+‡¶ì\s+/);
        return parts.map(function(p) { return p.trim(); }).filter(function(p) { return p.length > 0 && !isOnlyNumber(p); });
    }

    function numberWithBengali(lines) {
        var digits = '‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ';
        return lines.map(function(ln, i) {
            var numStr = String(i + 1).replace(/[0-9]/g, function(d) { return digits[d]; });
            return numStr + '. ' + ln;
        });
    }

    function buildConsolidatedForFlow(flow) {
        // ‡¶∂‡ßÅ‡¶ß‡ßÅ Delivery Flow Set ‡¶è‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞‡ßá‡¶∞ clone ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨
        var deliverySections = document.getElementById('deliveryFlowSections');
        var nodes = deliverySections ? Array.prototype.slice.call(deliverySections.querySelectorAll('.delivery-flow-cloned-card')) : [];
        var items = [];
        nodes.forEach(function(node) {
            var createdIso = node.getAttribute('data-created') || '';
            if (!createdIso) return;
            var d = new Date(createdIso);
            if (isNaN(d.getTime())) return;
            var minutes = d.getHours() * 60 + d.getMinutes();
            var sMin = (function(t){var p=t.split(':'),h=parseInt(p[0],10),m=parseInt(p[1],10);return isNaN(h)||isNaN(m)?null:h*60+m;})(flow.start);
            var eMin = (function(t){var p=t.split(':'),h=parseInt(p[0],10),m=parseInt(p[1],10);return isNaN(h)||isNaN(m)?null:h*60+m;})(flow.end);
            if (sMin === null || eMin === null) return;
            if (minutes < sMin || minutes > eMin) return;
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ AI ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü) ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶¨‡ßã
            var aiEl = node.querySelector('.list-entry-sections .list-section:nth-child(2) .list-section-content');
            var srcText = (aiEl && aiEl.textContent.trim()) || '';
            if (!srcText) return;
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡ßß. / 2. ) ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≠‡¶æ‡¶ó ‚Äî ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ø‡ßá‡¶Æ‡¶® '‡ßß ‡¶ï‡ßá‡¶ú‡¶ø', '‡ß´‡ß¶‡ß¶ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ' ‡¶≠‡¶æ‡¶ó ‡¶π‡¶¨‡ßá ‡¶®‡¶æ
            var numberPattern = /(?=[‡ß¶-‡ßØ0-9]+\.\s+)/;
            srcText.split(/\n/).forEach(function(raw) {
                raw.trim().split(numberPattern).forEach(function(seg) {
                    seg = seg.trim();
                    if (!seg) return;
                    var line = stripNumberPrefix(seg);
                    if (!line || isOnlyNumber(line)) return;
                    lineToSingleItems(line).forEach(function(one) { items.push(one); });
                });
            });
        });

        var wrap = consolidatedPanel.querySelector('.inline-merged-list');
        if (!wrap) {
            wrap = document.createElement('div');
            wrap.className = 'inline-merged-list';
            consolidatedPanel.appendChild(wrap);
        }
        var emptyEl = consolidatedPanel.querySelector('.inline-panel-empty');
        if (emptyEl) emptyEl.remove();
        wrap.innerHTML = '';
        if (!items.length) {
            var p = document.createElement('p');
            p.className = 'inline-panel-empty';
            p.textContent = '‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶®‡ßá‡¶á‡•§';
            consolidatedPanel.appendChild(p);
            return;
        }
        var numberedLines = numberWithBengali(items);
        var copyText = numberedLines.join('\n');
        var contentDiv = document.createElement('div');
        contentDiv.className = 'list-section-content ai-content';
        contentDiv.textContent = copyText;
        wrap.appendChild(contentDiv);
        wrap.setAttribute('data-copy-text', copyText);
        wrap.onclick = function() {
            var text = wrap.getAttribute('data-copy-text') || '';
            if (!text) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() { showCopyToast(); }).catch(function() { fallbackCopy(text); });
            } else { fallbackCopy(text); }
        };
        var hint = document.createElement('div');
        hint.className = 'copy-hint';
        hint.textContent = '‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ï‡¶™‡¶ø ‡¶π‡¶¨‡ßá ‚Äî ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶è‡¶ï ‡¶≤‡¶æ‡¶á‡¶®‡ßá';
        wrap.appendChild(hint);
    }

    function showCopyToast() {
        var existing = document.querySelector('.consolidated-copy-toast');
        if (existing) existing.remove();
        var toast = document.createElement('div');
        toast.className = 'consolidated-copy-toast';
        toast.textContent = '‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';
        document.body.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 2500);
    }
    function fallbackCopy(text) {
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        try {
            document.execCommand('copy');
            showCopyToast();
        } catch (e) {}
        document.body.removeChild(ta);
    }

    function setupFlowSelectorAndConsolidated() {
        if (!flowSelector || !consolidatedPanel) return;
        var flows = getValidFlowsForConsolidation();
        flowSelector.innerHTML = '';
        if (!flows.length) {
            flowSelector.style.display = 'none';
            return;
        }
        flowSelector.style.display = 'flex';
        flows.forEach(function(flow, idx) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'flow-consolidated-option';
            btn.textContent = flow.label;
            btn.addEventListener('click', function() {
                // active ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                flowSelector.querySelectorAll('.flow-consolidated-option').forEach(function(b){ b.classList.remove('active'); });
                btn.classList.add('active');
                buildConsolidatedForFlow(flow);
            });
            flowSelector.appendChild(btn);
            // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶ü‡¶ø‡¶ï‡ßá ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ö‡¶æ‡¶≤‡¶æ‡¶á
            if (idx === 0) {
                btn.classList.add('active');
                buildConsolidatedForFlow(flow);
            }
        });
    }

    function applyUserViewFilter(flow) {
        var items = document.querySelectorAll('#inlineUserViewPanel .inline-user-item');
        items.forEach(function(userItem) {
            var anyVisible = false;
            var visibleCount = 0;
            var listItems = userItem.querySelectorAll('.inline-list-item');
            listItems.forEach(function(li) {
                var createdIso = li.getAttribute('data-created') || '';
                if (!createdIso) {
                    li.style.display = 'none';
                    return;
                }
                var d = new Date(createdIso);
                if (isNaN(d.getTime())) {
                    li.style.display = 'none';
                    return;
                }
                var minutes = d.getHours() * 60 + d.getMinutes();
                var sMin = (function(t){var p=t.split(':'),h=parseInt(p[0],10),m=parseInt(p[1],10);return isNaN(h)||isNaN(m)?null:h*60+m;})(flow.start);
                var eMin = (function(t){var p=t.split(':'),h=parseInt(p[0],10),m=parseInt(p[1],10);return isNaN(h)||isNaN(m)?null:h*60+m;})(flow.end);
                if (sMin === null || eMin === null) {
                    li.style.display = 'none';
                    return;
                }
                if (minutes >= sMin && minutes <= eMin) {
                    li.style.display = '';
                    anyVisible = true;
                    visibleCount += 1;
                } else {
                    li.style.display = 'none';
                }
            });
            // badge count ke visible list er sathe match kori
            var badge = userItem.querySelector('.inline-user-badge');
            if (badge) {
                badge.textContent = visibleCount;
            }
            userItem.style.display = anyVisible ? '' : 'none';
        });
    }

    function setupFlowSelectorForUserView() {
        if (!flowUserSelector || !userViewPanel) return;
        var flows = getValidFlowsForConsolidation();
        flowUserSelector.innerHTML = '';
        if (!flows.length) {
            flowUserSelector.style.display = 'none';
            // ‡¶∏‡¶¨ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶á
            document.querySelectorAll('#inlineUserViewPanel .inline-user-item, #inlineUserViewPanel .inline-list-item')
                .forEach(function(el){ el.style.display = ''; });
            return;
        }
        flowUserSelector.style.display = 'flex';
        flows.forEach(function(flow, idx) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'flow-consolidated-option';
            btn.textContent = flow.label;
            btn.addEventListener('click', function() {
                flowUserSelector.querySelectorAll('.flow-consolidated-option').forEach(function(b){ b.classList.remove('active'); });
                btn.classList.add('active');
                applyUserViewFilter(flow);
            });
            flowUserSelector.appendChild(btn);
            if (idx === 0) {
                btn.classList.add('active');
                applyUserViewFilter(flow);
            }
        });
    }
    if (consolidatedBtn && consolidatedPanel) {
        consolidatedBtn.addEventListener('click', function() {
            var wasOpen = consolidatedPanel.classList.contains('show');
            consolidatedPanel.classList.toggle('show');
            consolidatedBtn.classList.toggle('active', !wasOpen);
            if (!wasOpen) {
                // ‡¶è‡¶ñ‡¶® ‡¶ì‡¶™‡ßá‡¶® ‡¶π‡¶ö‡ßç‡¶õ‡ßá -> Delivery Flow Set ‡¶è‡¶∞ ‡¶´‡ßç‡¶≤‡ßã‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶ï‡¶®‡¶∏‡¶≤‡¶ø‡¶°‡ßá‡¶ü‡ßá‡¶° ‡¶¨‡¶æ‡¶®‡¶æ‡¶á
                setupFlowSelectorAndConsolidated();
            }
            if (!wasOpen && userViewPanel) {
                userViewPanel.classList.remove('show');
                if (userViewBtn) userViewBtn.classList.remove('active');
            }
            updateVisibility();
        });
    }
    if (userViewBtn && userViewPanel) {
        userViewBtn.addEventListener('click', function() {
            var wasOpen = userViewPanel.classList.contains('show');
            userViewPanel.classList.toggle('show');
            userViewBtn.classList.toggle('active', !wasOpen);
            if (!wasOpen) {
                // ‡¶è‡¶ñ‡¶® ‡¶ì‡¶™‡ßá‡¶® ‡¶π‡¶ö‡ßç‡¶õ‡ßá -> Delivery Flow Set ‡¶è‡¶∞ ‡¶´‡ßç‡¶≤‡ßã‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá User View ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶ø
                setupFlowSelectorForUserView();
            } else {
                // ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶≤‡ßá ‡¶∏‡¶¨ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ì ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶á
                document.querySelectorAll('#inlineUserViewPanel .inline-user-item, #inlineUserViewPanel .inline-list-item')
                    .forEach(function(el){ el.style.display = ''; });
            }
            if (!wasOpen && consolidatedPanel) {
                consolidatedPanel.classList.remove('show');
                if (consolidatedBtn) consolidatedBtn.classList.remove('active');
            }
            updateVisibility();
        });
    }
    // Header back buttons
    document.querySelectorAll('.inline-panel-back').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var target = btn.getAttribute('data-target');
            if (target === 'consolidated' && consolidatedPanel && consolidatedBtn) {
                consolidatedPanel.classList.remove('show');
                consolidatedBtn.classList.remove('active');
            } else if (target === 'user' && userViewPanel && userViewBtn) {
                userViewPanel.classList.remove('show');
                userViewBtn.classList.remove('active');
                // ‡¶∏‡¶¨ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ì ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶á
                document.querySelectorAll('#inlineUserViewPanel .inline-user-item, #inlineUserViewPanel .inline-list-item')
                    .forEach(function(el){ el.style.display = ''; });
            }
            updateVisibility();
        });
    });
    document.querySelectorAll('#inlineUserViewPanel .inline-user-item .name').forEach(function(nameEl) {
        nameEl.addEventListener('click', function(e) {
            e.stopPropagation();
            var item = this.closest('.inline-user-item');
            var dd = item && item.querySelector('.inline-lists-dropdown');
            if (dd) { dd.classList.toggle('show'); item.classList.toggle('open'); }
        });
    });
})();
</script>
{% endblock %}
