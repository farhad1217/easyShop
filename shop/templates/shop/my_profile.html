{% extends 'shop/base.html' %}
{% block title %}‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ - EasyShop{% endblock %}
{% block extra_css %}
<style>
.profile-page { max-width: 560px; margin: 0 auto; }
.profile-hero {
    position: relative;
    padding-bottom: 48px;
    background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
    border-radius: 20px;
    padding: 28px;
    color: white;
    text-align: center;
    margin-bottom: 24px;
    box-shadow: 0 8px 32px rgba(13, 148, 136, 0.3);
}
.profile-hero .logout-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    padding: 8px 14px;
    font-size: 0.9rem;
    background: rgba(255,255,255,0.25);
    border-color: rgba(255,255,255,0.4);
}
.profile-hero .logout-btn:hover { background: rgba(255,255,255,0.4); }
.profile-back-icon {
    position: absolute;
    top: 16px;
    left: 16px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    color: white;
    text-decoration: none;
    transition: background 0.2s;
}
.profile-back-icon:hover { background: rgba(255,255,255,0.35); color: white; }
.profile-avatar-wrap {
    width: 100px; height: 100px;
    border-radius: 50%;
    overflow: hidden;
    margin: 0 auto 12px;
    border: 4px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.2);
    cursor: pointer;
    position: relative;
}
.profile-avatar-wrap img { width: 100%; height: 100%; object-fit: cover; }
.profile-avatar-wrap .avatar-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; }
.profile-name { font-size: 1.5rem; font-weight: 700; margin: 0 0 8px 0; }
.profile-info-panel {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 24px;
    border: 1px solid #e5e7eb;
}
.profile-info-panel h3 { margin: 0 0 16px 0; color: var(--primary); font-size: 1.1rem; }
.info-grid { display: grid; gap: 12px; }
.info-row { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
.info-row:last-child { border-bottom: none; }
.info-label { font-weight: 600; color: #6b7280; min-width: 100px; font-size: 0.9rem; }
.info-val { flex: 1; color: #1f2937; }
.section-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; }
.section-card h3 { margin: 0 0 16px 0; color: var(--primary); font-size: 1rem; }
.section-toggle { cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
.section-toggle .chevron { transition: transform 0.2s; }
.section-card.collapsed .section-toggle .chevron { transform: rotate(-90deg); }
.section-card.collapsed .section-body { display: none; }
.form-input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-family: inherit; }
textarea.form-input { resize: vertical; min-height: 80px; }
.logout-btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 20px; background: #fee2e2; color: #dc2626;
    border-radius: 10px; text-decoration: none; font-weight: 600;
    border: 2px solid #fecaca; transition: all 0.2s;
}
.logout-btn:hover { background: #fecaca; }
#avatarGalleryInput, #avatarCameraInput { display: none; }
.avatar-menu { position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%); background: white; border-radius: 12px; padding: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; gap: 8px; z-index: 10; }
.avatar-menu-btn { padding: 10px 16px; border: none; border-radius: 8px; background: #f3f4f6; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
.avatar-menu-btn:hover { background: #e5e7eb; }
@media (max-width: 600px) {
    .profile-hero { padding: 20px; }
    .profile-avatar-wrap { width: 80px; height: 80px; }
}
</style>
{% endblock %}
{% block content %}
<div class="container profile-page">
    <div class="profile-hero">
        <a href="{% url 'family_dashboard' %}" class="profile-back-icon" title="‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </a>
        <a href="{% url 'user_logout' %}" class="logout-btn" title="‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
        </a>
        <form id="avatarForm" method="post" enctype="multipart/form-data" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="avatar">
            <input type="file" name="avatar" id="avatarGalleryInput" accept="image/*">
            <input type="file" name="avatar" id="avatarCameraInput" accept="image/*" capture="environment">
        </form>
        <div class="profile-avatar-wrap" id="avatarClickArea">
            {% if profile.avatar %}
            <img src="{{ profile.avatar.url }}" alt="‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤">
            {% else %}
            <div class="avatar-placeholder">üë§</div>
            {% endif %}
        </div>
        <h2 class="profile-name">{{ profile.display_name|default:user.username }}</h2>
        <div id="avatarMenu" class="avatar-menu" style="display:none;">
            <button type="button" class="avatar-menu-btn" id="avatarGalleryBtn">üìÅ ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø</button>
            <button type="button" class="avatar-menu-btn" id="avatarCameraBtn">üì∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ</button>
        </div>
    </div>

    <div class="profile-info-panel">
        <h3>üìã ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="profile">
            {% for field in profile_form %}
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px;">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}<div style="color: #dc2626; font-size: 0.85rem; margin-top: 4px;">{{ field.errors.0 }}</div>{% endif %}
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </form>
    </div>

    <div class="section-card" id="accountSettingsCard">
        <h3 class="section-toggle" id="passwordToggle" tabindex="0">‚öôÔ∏è ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® <span class="chevron">‚ñº</span></h3>
        <div class="section-body">
            <form method="post" style="margin-top: 16px;">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="password">
                {% for field in password_form %}
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 6px;">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}<div style="color: #dc2626; font-size: 0.85rem; margin-top: 4px;">{{ field.errors.0 }}</div>{% endif %}
                </div>
                {% endfor %}
                <button type="submit" class="btn btn-primary">‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </form>
        </div>
    </div>
</div>

<script>
(function(){
    var avatarArea = document.getElementById('avatarClickArea');
    var galleryInp = document.getElementById('avatarGalleryInput');
    var cameraInp = document.getElementById('avatarCameraInput');
    var avatarForm = document.getElementById('avatarForm');
    var menu = document.getElementById('avatarMenu');
    var galBtn = document.getElementById('avatarGalleryBtn');
    var camBtn = document.getElementById('avatarCameraBtn');
    if (avatarArea && menu) {
        avatarArea.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            menu.style.display = menu.style.display === 'none' ? 'flex' : 'none';
        });
        document.addEventListener('click', function() { menu.style.display = 'none'; });
    }
    if (galBtn && galleryInp) galBtn.addEventListener('click', function() { galleryInp.click(); });
    if (camBtn && cameraInp) camBtn.addEventListener('click', function() { cameraInp.click(); });
    if (galleryInp) galleryInp.addEventListener('change', function() { if (this.files.length) avatarForm.submit(); });
    if (cameraInp) cameraInp.addEventListener('change', function() { if (this.files.length) avatarForm.submit(); });

    var card = document.getElementById('accountSettingsCard');
    var toggle = document.getElementById('passwordToggle');
    if (card && toggle) {
        card.classList.add('collapsed');
        toggle.addEventListener('click', function() { card.classList.toggle('collapsed'); });
        toggle.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.classList.toggle('collapsed'); } });
    }
})();
</script>
{% endblock %}
